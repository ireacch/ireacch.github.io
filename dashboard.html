<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>I-REACCH | Dashboard</title>

  <link rel="stylesheet" href="assets/css/brand.css"/>
  <link rel="stylesheet" href="assets/css/header.css"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --page-max: 1200px;
      --border:#e6ecf1; --text:#1b2a41; --muted:#556070;
      --band:#cfe4e7; --white:#fff;
      --grad-a:#4a1ea8; --grad-b:#0aa0ff;
      --good:#22a06b; --bad:#d14d4d;
    }
    .hero-slab{background:var(--band);padding:28px 0 22px;border-bottom:1px solid #c3d6d9}
    .wrap{max-width:var(--page-max);margin:0 auto;padding:0 24px}
    @media (max-width:640px){.wrap{padding:0 16px}}
    .h1{font-weight:800;margin:0;font-size:clamp(1.6rem,2.6vw,2.1rem)}
    .sub{color:var(--muted);margin-top:6px}

    .panel{background:var(--white);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(28,39,51,.04)}
    .pad{padding:18px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .pill{font-size:.85rem;background:#eef2f7;color:#556070;padding:4px 10px;border-radius:999px;font-weight:700}
    .btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:800;color:#fff;background:linear-gradient(90deg,var(--grad-a),var(--grad-b));cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:#1b2a41}
    .btn.tiny{padding:6px 10px;font-size:.85rem}
    .hint{font-size:.9rem;color:var(--muted)}
    .muted{color:var(--muted)}
    .h2{font-weight:800;margin:0 0 10px;font-size:clamp(1.3rem,2.2vw,1.6rem)}

    .kpis{display:flex;gap:18px;flex-wrap:wrap;font-weight:800}
    .kpi{display:flex;flex-direction:column}
    .kpi .v{font-size:clamp(1.05rem,2vw,1.3rem)}
    .chip{font-weight:800;padding:.15rem .5rem;border-radius:999px}
    .chip.good{background:#eaf7f1;color:var(--good)}
    .chip.bad{background:#fdecec;color:var(--bad)}

    .grid-2{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media (max-width:1080px){.grid-2{grid-template-columns:1fr}}
    .mini-grid{display:grid;grid-template-columns:260px 1fr;gap:18px}
    @media (max-width:900px){.mini-grid{grid-template-columns:1fr}}
    .mini-table{border-collapse:collapse;border:2px solid #2e4b6a;border-radius:8px;overflow:hidden;width:100%}
    .mini-table th,.mini-table td{border:2px solid #2e4b6a;padding:8px 10px;text-align:center;font-weight:700}

    .likert-caption{font-size:.9rem;color:var(--muted);margin-top:6px}
    .hide{display:none}
    canvas{max-width:100%}
    .ai-box{border:1px solid var(--border);border-radius:12px;padding:14px 16px;background:#fff}
    .ai-small{color:var(--muted);font-size:.95rem}
  </style>
</head>
<body>
  <header class="hero-slab">
    <div class="wrap">
      <h1 class="h1">Dashboard <span class="pill">beta</span></h1>
      <div class="sub">Clear, reproducible summaries of each micro-survey — with optional AI text on top of exact numbers.</div>
    </div>
  </header>

  <main class="wrap" style="margin:20px auto 40px">
    <!-- CONTROLS + KPIs -->
    <section class="panel pad" style="margin-bottom:18px">
      <div class="row">
        <div class="row" style="gap:10px">
          <span class="pill">Dataset</span>
          <select id="surveySelect" class="pill" aria-label="Select dataset"></select>
          <label class="pill" style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="compareToggle"> compare
          </label>
          <select id="compareSelect" class="pill" disabled aria-label="Compare with dataset"></select>
        </div>
        <div class="row" style="gap:8px">
          <button id="btnExportExcel" class="btn ghost" title="Export current survey to Excel (Copilot-ready)">Export to Excel</button>
          <button id="btnRefresh" class="btn ghost">Reload data</button>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><div class="muted">Responses</div><div class="v" id="kpi-total">–</div></div>
        <div class="kpi"><div class="muted">Scored</div><div class="v" id="kpi-scored">–</div></div>
        <div class="kpi"><div class="muted">Avg.</div><div class="v" id="kpi-avg">–</div></div>
        <div class="kpi"><div class="muted">Median</div><div class="v" id="kpi-med">–</div></div>
        <div class="kpi"><div class="muted">Positive (4–5)</div><div class="v" id="kpi-pos">–</div></div>
        <div class="kpi"><div class="muted">Neutral (3)</div><div class="v" id="kpi-neu">–</div></div>
        <div class="kpi"><div class="muted">Negative (1–2)</div><div class="v" id="kpi-neg">–</div></div>
        <div class="kpi"><div class="muted">Highlights</div><div class="v" id="kpi-flags"></div></div>
      </div>
      <div class="hint" style="margin-top:6px">
        % values are based on <b>scored</b> responses (<span id="kpi-scored-note">n=–</span>). Data: <code>data/datasets.json</code> + CSVs.
      </div>
    </section>

    <!-- RESPONSE DISTRIBUTION -->
    <section class="panel pad" style="margin-bottom:18px">
      <div class="row">
        <h2 class="h2" style="margin:0">Response distribution</h2>
        <div class="row" style="gap:8px">
          <button id="btnDownloadLikert" class="btn ghost tiny" title="Download chart as PNG">Download PNG</button>
        </div>
      </div>
      <div class="mini-grid">
        <table class="mini-table" aria-label="Score table">
          <thead><tr><th>Score</th><th>Count</th><th>%</th></tr></thead>
          <tbody id="scoreTable"></tbody>
        </table>
        <div>
          <canvas id="likertBar" height="220" aria-label="Likert distribution"></canvas>
          <div id="likertCaption" class="likert-caption"></div>
        </div>
      </div>
    </section>

    <!-- SUMMARY + THEMES (side-by-side) -->
    <section class="grid-2" style="margin-bottom:18px">
      <div class="panel pad">
        <div class="row">
          <h2 class="h2" style="margin:0">Plain-language summary & quick actions</h2>
          <button id="btnCopySummary" class="btn ghost tiny" title="Copy summary and actions">Copy summary</button>
        </div>
        <div id="plainSummary" class="ai-small">—</div>
        <div style="margin-top:10px">
          <b>Quick actions</b>
          <ul id="quickActions" class="ai-small" style="margin:.2rem 0 0 1rem"></ul>
        </div>
      </div>

      <aside class="panel pad">
        <h2 class="h2">Themes & quotes</h2>
        <div id="themeList" class="ai-small">—</div>
        <div class="muted" style="margin-top:6px">Examples</div>
        <ul id="themeQuotes" class="ai-small" style="margin:.2rem 0 0 1rem"></ul>
      </aside>
    </section>

    <!-- COMPARE -->
    <section id="comparePanel" class="panel pad hide" style="margin-bottom:18px">
      <div class="row">
        <h2 class="h2" style="margin:0">Compare Q1/Q2</h2>
        <div class="row">
          <div class="pill">Δ Avg <span id="delta-avg" class="chip" style="margin-left:6px">–</span></div>
          <div class="pill">Δ Positive <span id="delta-pos" class="chip" style="margin-left:6px">–</span></div>
        </div>
      </div>
      <canvas id="likertCompare" height="240"></canvas>
    </section>

    <!-- AI INSIGHTS -->
    <section class="panel pad">
      <h2 class="h2">AI insights</h2>
      <div class="row">
        <input id="aiPrompt" class="pill" style="padding:10px 12px;width:min(680px,100%)" placeholder="Ask AI about these results (e.g., ‘key risks by theme?’)"/>
        <button id="btnExplain" class="btn">Generate insights</button>
      </div>
      <div class="ai-box" id="aiOut" style="display:none;margin-top:10px">
        <div id="aiSummary" class="ai-small"></div>
        <div id="aiActions" class="ai-small" style="margin-top:8px"></div>
      </div>
      <div class="hint" style="margin-top:6px">No Azure OpenAI? Export to Excel above and use <b>Copilot in Excel</b> for secure analysis inside Microsoft 365.</div>
    </section>
  </main>

  <script>
    /* ------------ helpers ------------ */
    const $ = s => document.querySelector(s);
    const palette5 = ["#c7d2fe","#a5b4fc","#818cf8","#6366f1","#4f46e5"]; // 1..5 light→dark

    async function fetchJSON(url){ const r=await fetch(url+(url.includes('?')?'&':'?')+'cb='+Date.now()); if(!r.ok) throw new Error(r.status); return r.json(); }
    async function fetchText(url){ const r=await fetch(url+(url.includes('?')?'&':'?')+'cb='+Date.now()); if(!r.ok) throw new Error(r.status); return r.text(); }

    function parseCSV(text){
      const rows=[]; let i=0,cell='',row=[],inQ=false;
      const pushCell=()=>{row.push(cell);cell='';}, pushRow=()=>{rows.push(row);row=[];};
      while(i<text.length){ const ch=text[i];
        if(inQ){ if(ch=='"'){ if(text[i+1]=='"'){cell+='"';i++;} else inQ=false; } else cell+=ch; }
        else{ if(ch=='"') inQ=true; else if(ch==',') pushCell();
          else if(ch=='\n'||ch=='\r'){ if(cell.length||row.length){pushCell();pushRow();} while(text[i+1]=='\n'||text[i+1]=='\r') i++; }
          else cell+=ch; }
        i++;
      }
      if(cell.length||row.length){ pushCell(); pushRow(); }
      const head = rows.shift()||[];
      return rows.map(r=>Object.fromEntries(head.map((h,idx)=>[h.trim().replace(/^\uFEFF/,''),(r[idx]??'').trim()])));
    }

    const LIKERT = {
      'strongly disagree':1,'disagree':2,'neither agree nor disagree':3,'neutral':3,'agree':4,'strongly agree':5,
      'very dissatisfied':1,'dissatisfied':2,'neither satisfied nor dissatisfied':3,'satisfied':4,'very satisfied':5,
      'extremely unvalued':1,'somewhat unvalued':2,'somewhat valued':4,'extremely valued':5,
      'extremely not confident':1,'somewhat not confident':2,'neutral confidence':3,'somewhat confident':4,'extremely confident':5
    };
    function toScore(v){
      if(v==null) return null;
      const t=String(v).trim(); if(!t) return null;
      const n=Number(t); if(!Number.isNaN(n)&&n>=1&&n<=5) return n;
      const key=t.toLowerCase().replace(/[^a-z ]+/g,' ').replace(/\s+/g,' ').trim();
      return LIKERT[key] ?? null;
    }
    const BLACKLIST = /(^(id|email|name)$)|start|completion|timestamp|time/i;
    function detectColumns(rows){
      const headers = rows.length? Object.keys(rows[0]) : [];
      let best={col:null,rate:0};
      for(const h of headers){
        if(BLACKLIST.test(h)) continue;
        const hits=rows.reduce((n,r)=> n+(toScore(r[h])!=null?1:0),0);
        const rate=rows.length? hits/rows.length : 0;
        if(rate>best.rate) best={col:h,rate};
      }
      const scoreCol=best.rate>=0.6?best.col:null;
      const textCol=headers.find(h=>/comment|free|text|feedback/i.test(h))||null;
      return {scoreCol,textCol};
    }
    function median(arr){ if(!arr.length) return 0; const s=[...arr].sort((a,b)=>a-b); const m=Math.floor(s.length/2); return s.length%2? s[m] : (s[m-1]+s[m])/2; }

    /* ------------ load datasets ------------ */
    let ALL=[], CURRENT_ID=null;

    function normalizeIndex(index){
      const base = Array.isArray(index)? index
        : Array.isArray(index.surveys)? index.surveys
        : Array.isArray(index.datasets)? index.datasets.map(d=>({id:d.id,title:d.title||d.id,csv:(Array.isArray(d.files)&&d.files[0])?d.files[0]:"",answerColumn:d.answerColumn||d.answer||"",textColumn:d.textColumn||d.text||""}))
        : [];
      return base.map(d=>({ id:d.id, title:d.title||d.id, csv:d.csv||"", answerColumn:d.answerColumn||"", textColumn:d.textColumn||"" }));
    }

    async function loadAll(){
      const defs = normalizeIndex(await fetchJSON('data/datasets.json'));
      const out=[];
      for(const def of defs){
        if(!def.csv) continue;
        const text = await fetchText(def.csv);
        const rows = parseCSV(text);
        const auto = detectColumns(rows);
        const headers = rows.length? Object.keys(rows[0]) : [];
        const scoreCol = (def.answerColumn && headers.includes(def.answerColumn)) ? def.answerColumn : auto.scoreCol;
        const textCol  = (def.textColumn   && headers.includes(def.textColumn))   ? def.textColumn   : auto.textCol;
        out.push({ id:def.id, title:def.title||def.id, csv:def.csv, rows, scoreCol, textCol });
      }
      ALL = out;
      if(!CURRENT_ID || !ALL.some(s=>s.id===CURRENT_ID)) CURRENT_ID = ALL[0]?.id || null;
      buildSelects();
    }

    /* ------------ summarise ------------ */
    function roundPercentsTo100(counts){
      const total = counts.reduce((a,b)=>a+b,0) || 0;
      if(!total) return counts.map(()=>0);
      const raw = counts.map(c => 100*c/total);
      const floored = raw.map(Math.floor);
      let remainder = 100 - floored.reduce((a,b)=>a+b,0);
      const fracIdx = raw.map((v,i)=>({i,f:v-Math.floor(v)})).sort((a,b)=>b.f-a.f).map(x=>x.i);
      const result = [...floored];
      for(let k=0;k<remainder;k++) result[fracIdx[k%fracIdx.length]]++;
      return result;
    }

    function summarise(s){
      const scores=[], texts=[];
      for(const r of s.rows){
        const v=s.scoreCol? toScore(r[s.scoreCol]) : null;
        if(v!=null) scores.push(v);
        if(s.textCol && r[s.textCol]) texts.push(r[s.textCol]);
      }
      const total=s.rows.length, scored=scores.length, blanks=total-scored;
      const avg=scored? scores.reduce((a,b)=>a+b,0)/scored : 0;
      const med=scored? median(scores) : 0;
      const posPct=scored? Math.round(100*scores.filter(v=>v>=4).length/scored) : 0;
      const negPct=scored? Math.round(100*scores.filter(v=>v<=2).length/scored) : 0;

      const counts=[1,2,3,4,5].map(v=>scores.filter(x=>x===v).length);
      const perc = roundPercentsTo100(counts);

      const dist=[1,2,3,4,5].map((v,i)=>({score:v, n:counts[i], p:perc[i]}));
      return { id:s.id,title:s.title,total,scored,blanks,avg,med,posPct,negPct,dist,texts };
    }
    function summariseAll(){ return ALL.map(s=>summarise(s)); }

    /* ------------ UI + charts ------------ */
    let chLikert, chCompare;

    function buildSelects(){
      const sel=$('#surveySelect'), cmp=$('#compareSelect');
      const prev=sel.value, prevCmp=cmp.value;
      sel.innerHTML=""; cmp.innerHTML="";
      ALL.forEach(s=>{
        sel.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.title}</option>`);
        cmp.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.title}</option>`);
      });
      sel.value = ALL.some(s=>s.id===prev)? prev : (CURRENT_ID||ALL[0]?.id||"");
      cmp.value = ALL.find(s=>s.id!==sel.value)?.id || ALL[0]?.id || "";
      CURRENT_ID = sel.value;
      $('#compareSelect').disabled = !$('#compareToggle').checked;
      $('#comparePanel').classList.toggle('hide', !$('#compareToggle').checked);
    }

    function fillKPIs(a){
      $('#kpi-total').textContent = a.total;
      $('#kpi-scored').textContent = a.scored;
      $('#kpi-avg').textContent = a.avg? a.avg.toFixed(2) : "–";
      $('#kpi-med').textContent = a.med? (Number.isInteger(a.med)? a.med : a.med.toFixed(1)) : "–";
      $('#kpi-pos').textContent = a.posPct + "%";
      $('#kpi-neu').textContent = (a.dist[2]?.p ?? 0) + "%";
      $('#kpi-neg').textContent = a.negPct + "%";
      $('#kpi-scored-note').textContent = "n=" + a.scored;

      const extremes = [];
      if(a.dist[0].n) extremes.push(`<span class="chip bad">${a.dist[0].n} × score 1</span>`);
      if(a.dist[1].n) extremes.push(`<span class="chip bad">${a.dist[1].n} × score 2</span>`);
      if(a.dist[4].n) extremes.push(`<span class="chip good">${a.dist[4].n} × score 5</span>`);
      $('#kpi-flags').innerHTML = extremes.join(' ') || '—';
    }

    function fillPlainSummary(a){
      const pos=a.posPct, neg=a.negPct, neu=(a.dist[2]?.p||0);
      $('#plainSummary').innerHTML =
        `Out of <b>${a.total}</b> responses, <b>${pos}%</b> are positive (4–5), <b>${neu}%</b> neutral (3), and <b>${neg}%</b> negative (1–2). `
        + `Average is <b>${a.avg.toFixed(2)}</b> (median ${Number.isInteger(a.med)?a.med:a.med.toFixed(1)}).`;
      const actions=[];
      if(pos<60) actions.push("Run a short focus group to understand low sentiment.");
      if(neu>=20) actions.push("Probe why many are neutral; clarify expectations or supports.");
      if(a.dist[0].n + a.dist[1].n >= 10) actions.push("Follow up with the bottom-scoring group confidentially.");
      if(!actions.length) actions.push("Share positives and maintain pulse checks.");
      $('#quickActions').innerHTML = actions.map(x=>`<li>${x}</li>`).join('');
    }

    function themesAndQuotes(texts){
      const stop=new Set("the,and,to,of,in,for,a,on,is,are,it,with,that,this,at,as,be,or,we,our,your,i,have,has,was,were,from,by,an,you,they,them,not,sure".split(','));
      const freq={};
      texts.forEach(t=>{
        t.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).forEach(w=>{
          if(!w||stop.has(w)||w.length<3) return; freq[w]=(freq[w]||0)+1;
        });
      });
      const top=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([label,count])=>({label,count}));
      $('#themeList').innerHTML = top.length ? top.map(t=>`• <b>${t.label}</b> (${t.count})`).join('<br>') : '—';
      const q=[];
      if(top[0]) for(const t of texts){ if(t.toLowerCase().includes(top[0].label) && q.length<2) q.push(t); }
      if(q.length<2 && top[1]) for(const t of texts){ if(t.toLowerCase().includes(top[1].label) && q.length<2) q.push(t); }
      $('#themeQuotes').innerHTML = q.length ? q.map(s=>`<li>“${s.replace(/"/g,'&quot;')}”</li>`).join('') : '<li>No free-text comments.</li>';
    }

    function fillTable(dist){
      $('#scoreTable').innerHTML = dist.map(d=>`<tr><td>${d.score}</td><td>${d.n}</td><td>${d.p}%</td></tr>`).join('');
    }

    function drawLikert(dist){
      const ds = dist.map((d,i)=>({ label:String(i+1), data:[d.n], backgroundColor:palette5[i], stack:'x' }));
      const ctx = document.getElementById('likertBar');
      if(chLikert) chLikert.destroy();
      chLikert = new Chart(ctx,{ type:'bar', data:{ labels:[''], datasets:ds },
        options:{ indexAxis:'y', scales:{ x:{stacked:true,beginAtZero:true,ticks:{precision:0}}, y:{stacked:true} }, plugins:{legend:{position:'bottom'}} }
      });
      const cap = dist.map(d=>`${d.score}: ${d.n} (${d.p}%)`).join(' • ');
      $('#likertCaption').textContent = cap;
    }

    function drawCompare(a,b){
      const ctx = document.getElementById('likertCompare');
      if(chCompare) chCompare.destroy();
      const ds = [0,1,2,3,4].map(i=>({
        label:String(i+1),
        data:[a.dist[i].n, b.dist[i].n],
        backgroundColor:palette5[i],
        stack:'x'
      }));
      chCompare = new Chart(ctx,{ type:'bar', data:{ labels:[a.title, b.title], datasets:ds },
        options:{ indexAxis:'y', scales:{ x:{stacked:true,beginAtZero:true}, y:{stacked:true} }, plugins:{legend:{position:'bottom'}} }
      });
      const dAvg=a.avg-b.avg, dPos=a.posPct-b.posPct;
      const chip=(el,n)=>{ el.textContent=(n>0?'+':'')+(Number.isInteger(n)?n:n.toFixed(2)); el.className='chip ' + (n>=0?'good':'bad'); };
      chip($('#delta-avg'), dAvg); chip($('#delta-pos'), dPos);
    }

    /* ------------ COPY + DOWNLOAD ------------ */
    function buildCopyText(){
      const sel = $('#surveySelect').value;
      const per = summariseAll();
      const cur = per.find(x=>x.id===sel) || per[0];
      const neu = cur.dist[2]?.p || 0;
      const lines = [
        `${cur.title} — topline`,
        `Responses: ${cur.total} (scored n=${cur.scored})`,
        `Average ${cur.avg.toFixed(2)} (median ${Number.isInteger(cur.med)?cur.med:cur.med.toFixed(1)})`,
        `Positive: ${cur.posPct}% • Neutral: ${neu}% • Negative: ${cur.negPct}%`,
        `Distribution: ${cur.dist.map(d=>`${d.score}=${d.n}(${d.p}%)`).join(', ')}`,
        ``,
        `Quick actions:`,
        ...Array.from(document.querySelectorAll('#quickActions li')).map(li=>`- ${li.textContent}`)
      ];
      return lines.join('\n');
    }

    async function copySummary(){
      const text = buildCopyText();
      try{
        await navigator.clipboard.writeText(text);
        $('#btnCopySummary').textContent = 'Copied!';
        setTimeout(()=>$('#btnCopySummary').textContent='Copy summary',1200);
      }catch{
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); }catch{}
        document.body.removeChild(ta);
        $('#btnCopySummary').textContent = 'Copied!';
        setTimeout(()=>$('#btnCopySummary').textContent='Copy summary',1200);
      }
    }

    function downloadLikertPNG(){
      if(!window.chLikert) return;
      const link = document.createElement('a');
      link.download = `${$('#surveySelect').value || 'survey'}-likert.png`;
      link.href = chLikert.toBase64Image();
      link.click();
    }

    /* ------------ EXPORT TO EXCEL (Copilot-ready) ------------ */
    function exportToExcel(){
      const sel = $('#surveySelect').value;
      const per = summariseAll();
      const cur = per.find(x=>x.id===sel) || per[0];

      // Sheet 1: Topline (as AoA)
      const topline = [
        [cur.title, "Topline"],
        ["Responses", cur.total],
        ["Scored (n)", cur.scored],
        ["Average", cur.avg.toFixed(2)],
        ["Median", Number.isInteger(cur.med)?cur.med:cur.med.toFixed(1)],
        ["Positive (4–5)", cur.posPct + "%"],
        ["Neutral (3)", (cur.dist[2]?.p||0) + "%"],
        ["Negative (1–2)", cur.negPct + "%"],
        [],
        ["Narrative"],
        [document.getElementById("plainSummary").textContent || ""]
      ];
      const wsTop = XLSX.utils.aoa_to_sheet(topline);

      // Sheet 2: Distribution
      const distAoA = [["Score","Count","%"]].concat(cur.dist.map(d=>[d.score,d.n,d.p]));
      const wsDist = XLSX.utils.aoa_to_sheet(distAoA);

      // Sheet 3: Responses (anonymised)
      // Only mapped score + free-text comment (when available)
      const sDef = ALL.find(s=>s.id===cur.id);
      const rows = (sDef?.rows || []).map(r=>{
        const sc = sDef?.scoreCol ? toScore(r[sDef.scoreCol]) : null;
        const tx = sDef?.textCol ? r[sDef.textCol] : "";
        return { "Score (1-5)": sc, "Comment": tx || "" };
      });
      const wsResp = XLSX.utils.json_to_sheet(rows, { header:["Score (1-5)","Comment"] });

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, wsTop, "Topline");
      XLSX.utils.book_append_sheet(wb, wsDist, "Distribution");
      XLSX.utils.book_append_sheet(wb, wsResp, "Responses (anonymised)");

      const fname = (cur.title || "survey").replace(/[^a-z0-9]+/gi,'_') + "_copilot.xlsx";
      XLSX.writeFile(wb, fname);
    }

    /* ------------ AI endpoint wiring (kept; optional) ------------ */
    const AI_URL = "/api/ai";
    async function callAIInsights(payload){
      const res = await fetch(AI_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('AI endpoint failed');
      return res.json();
    }
    function buildAIPayload(){
      const sel = $('#surveySelect').value;
      const per = summariseAll();
      const cur = per.find(x=>x.id===sel) || per[0];
      const themes = Array.from(document.querySelectorAll('#themeList b')).map(b=>{
        const parentText = b.parentElement?.textContent || '';
        const m = parentText.match(/\((\d+)\)\s*$/);
        return { label: b.textContent.trim(), count: m ? Number(m[1]) : undefined };
      });
      const quotes = Array.from(document.querySelectorAll('#themeQuotes li'))
        .map(li => li.textContent.replace(/^“|”$/g,'').trim())
        .slice(0,5);
      return {
        surveyTitle: cur.title,
        userPrompt: ($('#aiPrompt')?.value || '').trim(),
        kpis: {
          total: cur.total, scored: cur.scored,
          avg: Number(cur.avg.toFixed(2)),
          median: Number.isInteger(cur.med) ? cur.med : Number(cur.med.toFixed(1)),
          posPct: cur.posPct, neuPct: cur.dist[2]?.p || 0, negPct: cur.negPct
        },
        distribution: cur.dist.map(d => ({ score: d.score, n: d.n, pct: d.p })),
        themes, sampleQuotes: quotes
      };
    }
    async function generateInsights(){
      const btn = $('#btnExplain');
      const out = $('#aiOut');
      const sDiv = $('#aiSummary');
      const aDiv = $('#aiActions');

      btn.disabled = true; btn.textContent = 'Thinking…';
      sDiv.textContent = ''; aDiv.innerHTML = ''; out.style.display='block';

      try{
        const payload = buildAIPayload();
        const data = await callAIInsights(payload);

        sDiv.textContent = data.summary || '—';

        const prompt = ($('#aiPrompt')?.value || '').trim();
        const qa = (prompt && data.answer)
          ? `<div style="margin:.4rem 0"><b>Answer:</b> ${data.answer}</div>`
          : '';

        const risks = (data.risks && data.risks.length)
          ? `<div class="muted" style="margin:.4rem 0"><b>Risks:</b> ${data.risks.join('; ')}</div>`
          : '';

        const actions = (data.actions && data.actions.length)
          ? data.actions.map(x=>`<li>${x}</li>`).join('')
          : '<li>No specific actions returned.</li>';

        aDiv.innerHTML = `${qa}${risks}<b>Recommended actions</b><ul style="margin:.2rem 0 0 1rem">${actions}</ul>`;
      }catch(e){
        sDiv.textContent = 'Sorry — could not generate AI insights.';
        aDiv.textContent = String(e?.message || e);
      }finally{
        btn.disabled = false; btn.textContent = 'Generate insights';
      }
    }

    /* ------------ refresh pipeline ------------ */
    function refresh(){
      if(!ALL.length) return;
      const per = summariseAll();
      const cur = per.find(x=>x.id===CURRENT_ID) || per[0];

      fillKPIs(cur);
      fillTable(cur.dist);
      drawLikert(cur.dist);
      fillPlainSummary(cur);
      themesAndQuotes(cur.texts || []);

      const compareOn = $('#compareToggle').checked && ALL.length>1;
      $('#comparePanel').classList.toggle('hide', !compareOn);
      $('#compareSelect').disabled = !compareOn;
      if(compareOn){
        const other = per.find(x=>x.id === $('#compareSelect').value && x.id!==cur.id) || per.find(x=>x.id!==cur.id) || cur;
        drawCompare(cur, other);
      }
    }

    /* ------------ events ------------ */
    $('#surveySelect').addEventListener('change', e=>{ CURRENT_ID=e.target.value; refresh(); });
    $('#compareToggle').addEventListener('change', ()=>{ buildSelects(); refresh(); });
    $('#compareSelect').addEventListener('change', refresh);
    $('#btnRefresh').addEventListener('click', async ()=>{ await loadAll(); refresh(); });

    $('#btnCopySummary').addEventListener('click', copySummary);
    $('#btnDownloadLikert').addEventListener('click', downloadLikertPNG);
    $('#btnExportExcel').addEventListener('click', exportToExcel);

    // AI button → serverless endpoint (optional)
    $('#btnExplain').addEventListener('click', generateInsights);

    /* ------------ boot ------------ */
    (async function init(){
      try{ await loadAll(); buildSelects(); refresh(); }
      catch(e){ console.error(e); alert("Failed to load data. Check datasets.json and CSV paths."); }
    })();
  </script>
</body>
</html>
