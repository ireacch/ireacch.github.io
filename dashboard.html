<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>I-REACCH | Dashboard</title>

  <link rel="stylesheet" href="assets/css/brand.css"/>
  <link rel="stylesheet" href="assets/css/header.css"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --page-max: 1200px;
      --border:#e6ecf1; --text:#1b2a41; --muted:#556070;
      --band:#cfe4e7; --white:#fff;
      --grad-a:#4a1ea8; --grad-b:#0aa0ff;
      --good:#22a06b; --bad:#d14d4d; --warn:#c07c00;
      --chip:#eef2f7;
    }
    .hero-slab{background:var(--band);padding:28px 0 22px;border-bottom:1px solid #c3d6d9}
    .wrap{max-width:var(--page-max);margin:0 auto;padding:0 24px}
    @media (max-width:640px){.wrap{padding:0 16px}}
    .h1{font-weight:800;margin:0;font-size:clamp(1.6rem,2.6vw,2.1rem)}
    .sub{color:var(--muted);margin-top:6px}

    .panel{background:var(--white);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(28,39,51,.04)}
    .pad{padding:18px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .pill{font-size:.85rem;background:#eef2f7;color:#556070;padding:4px 10px;border-radius:999px;font-weight:700}
    .btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:800;color:#fff;background:linear-gradient(90deg,var(--grad-a),var(--grad-b));cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:#1b2a41}
    .btn.tiny{padding:6px 10px;font-size:.85rem}
    .hint{font-size:.9rem;color:var(--muted)}
    .muted{color:var(--muted)}
    .h2{font-weight:800;margin:0 0 10px;font-size:clamp(1.3rem,2.2vw,1.6rem)}

    .kpis{display:flex;gap:18px;flex-wrap:wrap;font-weight:800}
    .kpi{display:flex;flex-direction:column}
    .kpi .v{font-size:clamp(1.05rem,2vw,1.3rem)}
    .chip{font-weight:800;padding:.15rem .5rem;border-radius:999px}
    .chip.good{background:#eaf7f1;color:var(--good)}
    .chip.bad{background:#fdecec;color:var(--bad)}
    .chip.warn{background:#fff4de;color:var(--warn)}

    .grid-2{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media (max-width:1080px){.grid-2{grid-template-columns:1fr}}
    .mini-grid{display:grid;grid-template-columns:260px 1fr;gap:18px}
    @media (max-width:900px){.mini-grid{grid-template-columns:1fr}}
    .mini-table{border-collapse:collapse;border:2px solid #2e4b6a;border-radius:8px;overflow:hidden;width:100%}
    .mini-table th,.mini-table td{border:2px solid #2e4b6a;padding:8px 10px;text-align:center;font-weight:700}

    .likert-caption{font-size:.9rem;color:var(--muted);margin-top:6px}
    .hide{display:none}
    canvas{max-width:100%}
    .ai-box{border:1px solid var(--border);border-radius:12px;padding:14px 16px;background:#fff}
    .ai-small{color:var(--muted);font-size:.95rem}

    /* Minimal KPI detail toggle */
    .kpi-core{display:flex;gap:18px;flex-wrap:wrap}
    .kpi-detail{display:none;margin-top:10px}
    .kpi-toggle{cursor:pointer}

    /* Compare */
    .compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .cmp-table{width:100%;border-collapse:collapse}
    .cmp-table th,.cmp-table td{border:1px solid var(--border);padding:8px 10px;text-align:center}
    .cmp-table th{background:#f7f9fb}
    .badge{padding:2px 8px;border-radius:999px;font-weight:800;font-size:.8rem;display:inline-block}
    .badge.ok{background:#eaf7f1;color:var(--good)}
    .badge.risk{background:#fdecec;color:var(--bad)}
    .badge.smalln{background:#fff4de;color:var(--warn)}

    /* New: better summary + themes layout */
    .summary-grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
    @media (max-width:960px){.summary-grid{grid-template-columns:1fr}}
    .actions-list{margin:.2rem 0 0 1rem}
    .theme-chips{display:flex;flex-wrap:wrap;gap:6px}
    .theme-chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-weight:700;font-size:.85rem}
    .quote-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    @media (max-width:960px){.quote-grid{grid-template-columns:1fr}}
    .quote-card{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff}
    /* SHOW FULL QUOTE TEXT (no clipping) */
    .quote-card p{margin:0;line-height:1.4;word-break:break-word}

    .methods{font-size:.92rem;line-height:1.4;color:#2a3b52}
    details summary{cursor:pointer;font-weight:800}
  </style>
</head>
<body>
  <header class="hero-slab">
    <div class="wrap">
      <h1 class="h1">Dashboard <span class="pill">beta</span></h1>
      <div class="sub">Clear, reproducible summaries of each micro-survey — with Copilot-ready export for secure AI summaries in Microsoft 365.</div>
    </div>
  </header>

  <main class="wrap" style="margin:20px auto 40px">
    <!-- CONTROLS + KPIs -->
    <section class="panel pad" style="margin-bottom:18px">
      <div class="row">
        <div class="row" style="gap:10px">
          <span class="pill">Dataset</span>
          <select id="surveySelect" class="pill" aria-label="Select dataset"></select>
          <label class="pill" style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="compareToggle"> compare
          </label>
          <select id="compareSelect" class="pill" disabled aria-label="Compare with dataset"></select>
        </div>
        <div class="row" style="gap:8px">
          <button id="btnExportExcel" class="btn ghost" title="Export current survey to Excel (Copilot-ready)">Export to Excel</button>
          <button id="btnCopyWord" class="btn ghost" title="Copy topline + narrative for Word">Copy to Word</button>
          <button id="btnCopyCopilot" class="btn ghost" title="Copy a smart Copilot prompt tailored to this survey">Copy Copilot prompt</button>
          <button id="btnRefresh" class="btn ghost">Reload data</button>
        </div>
      </div>

      <!-- Minimal KPIs -->
      <div class="kpis" style="margin-top:12px">
        <div class="kpi-core">
          <div class="kpi"><div class="muted">Responses</div><div class="v" id="kpi-total">–</div></div>
          <div class="kpi"><div class="muted">Avg.</div><div class="v" id="kpi-avg">–</div></div>
          <div class="kpi"><div class="muted">Positive (4–5)</div><div class="v" id="kpi-pos">–</div></div>
          <div class="kpi"><div class="muted">Negative (1–2)</div><div class="v" id="kpi-neg">–</div></div>
          <div class="kpi hide" id="kpi-smalln"><div class="muted">Note</div><div class="v"><span class="chip warn">small n</span></div></div>
        </div>

        <div class="kpi-toggle pill" id="toggleDetail" style="margin-top:8px">more detail</div>

        <div class="kpi-detail" id="kpiDetail">
          <div class="kpi"><div class="muted">Scored</div><div class="v" id="kpi-scored">–</div></div>
          <div class="kpi"><div class="muted">Median</div><div class="v" id="kpi-med">–</div></div>
          <div class="kpi"><div class="muted">Neutral (3)</div><div class="v" id="kpi-neu">–</div></div>
          <div class="kpi"><div class="muted">Highlights</div><div class="v" id="kpi-flags"></div></div>
        </div>
      </div>

      <div class="hint" style="margin-top:6px">
        % values are based on <b>scored</b> responses (<span id="kpi-scored-note">n=–</span>). Data: <code>data/datasets.json</code> + CSVs.
      </div>
    </section>

    <!-- COMPARE lives here (we’ll move it above charts when compare=on) -->
    <section id="comparePanel" class="panel pad hide" style="margin-bottom:18px">
      <div class="row">
        <h2 class="h2" style="margin:0">Compare datasets</h2>
      </div>

      <div style="overflow-x:auto;margin-bottom:14px">
        <table class="cmp-table" id="cmpTopline" aria-label="Topline comparison"></table>
      </div>

      <div style="margin-bottom:14px">
        <h3 class="h2" style="font-size:1.1rem">Distribution change (percentage points)</h3>
        <canvas id="likertDelta" height="200"></canvas>
        <div class="hint">Positive bars mean the second dataset has a higher share for that score.</div>
      </div>

      <div class="compare-grid" style="margin-bottom:14px">
        <div class="panel pad" style="border:1px dashed var(--border)">
          <b>Theme overlap</b>
          <div id="cmpThemes" class="ai-small" style="margin-top:6px">—</div>
        </div>
        <div class="panel pad" style="border:1px dashed var(--border)">
          <b>Representative quotes</b>
          <ul id="cmpQuotes" class="ai-small" style="margin-top:6px;margin-left:1rem"></ul>
        </div>
      </div>

      <div class="ai-box">
        <b>One-paragraph summary</b>
        <div id="cmpNarrative" class="ai-small" style="margin-top:6px">—</div>
      </div>
    </section>

    <!-- RESPONSE DISTRIBUTION (compact) -->
    <section id="distributionPanel" class="panel pad" style="margin-bottom:18px">
      <div class="row">
        <h2 class="h2" style="margin:0">Response distribution</h2>
        <div class="row" style="gap:8px">
          <button id="btnDownloadLikert" class="btn ghost tiny" title="Download chart as PNG">Download PNG</button>
        </div>
      </div>
      <div class="mini-grid">
        <table class="mini-table" aria-label="Score table">
          <thead><tr><th>Score</th><th>Count</th><th>%</th></tr></thead>
          <tbody id="scoreTable"></tbody>
        </table>
        <div>
          <!-- shorter height for less visual weight -->
          <canvas id="likertBar" height="160" aria-label="Likert distribution"></canvas>
          <div id="likertCaption" class="likert-caption"></div>
        </div>
      </div>
    </section>

    <!-- SUMMARY + THEMES (balanced layout) -->
    <section class="grid-2" style="margin-bottom:18px">
      <div class="panel pad">
        <div class="row">
          <h2 class="h2" style="margin:0">Plain-language summary & quick actions</h2>
          <button id="btnCopySummary" class="btn ghost tiny" title="Copy summary and actions">Copy summary</button>
        </div>

        <div class="summary-grid">
          <div>
            <div id="plainSummary" class="ai-small">—</div>
          </div>
          <div id="quickActionsBox">
            <b>Quick actions</b>
            <ul id="quickActions" class="ai-small actions-list"></ul>
          </div>
        </div>
      </div>

      <aside class="panel pad">
        <h2 class="h2">Themes & quotes</h2>
        <div id="themeChips" class="theme-chips" aria-label="Top themes">—</div>
        <div class="quote-grid" id="quoteGrid" aria-label="Quote samples"></div>
      </aside>
    </section>

    <!-- METHODS -->
    <section class="panel pad methods">
      <details>
        <summary>Methods & definitions</summary>
        <div style="margin-top:10px">
          <ul>
            <li><b>Scores</b>: 1..5 Likert mapped from text labels (e.g., 1=“Extremely unvalued”, 5=“Extremely valued”).</li>
            <li><b>% Positive</b>: share of scored responses that are 4 or 5. <b>% Negative</b>: share that are 1 or 2. Base size shown as n.</li>
            <li><b>Small n</b>: if n&lt;30, a “small n” tag appears — interpret cautiously.</li>
            <li><b>Meaningful change</b>: Δ≥5 percentage points <i>and</i> two-proportion test p&lt;.05; otherwise shown as small/uncertain.</li>
            <li><b>Theme extraction</b>: simple tokenization with stopwords removed; top frequent terms; theme drift = overlap vs new vs dropped terms. Quotes are anonymised.</li>
            <li><b>Average/median</b>: reported descriptively; medians are preferred for skewed distributions.</li>
          </ul>
        </div>
      </details>
    </section>

    <!-- COPILOT HANDOFF -->
    <section class="panel pad">
      <h2 class="h2">Copilot analysis (Excel/Teams)</h2>
      <div class="hint">Use <b>Export to Excel</b> above, open it in Excel/Teams, then paste the copied prompt to get a full AI summary, comparisons, and actions — fully inside Microsoft 365.</div>
    </section>
  </main>

  <script>
    /* ------------ helpers ------------ */
    const $ = s => document.querySelector(s);
    const palette5 = ["#c7d2fe","#a5b4fc","#818cf8","#6366f1","#4f46e5"]; // 1..5 light→dark

    async function fetchJSON(url){ const r=await fetch(url+(url.includes('?')?'&':'?')+'cb='+Date.now()); if(!r.ok) throw new Error(r.status); return r.json(); }
    async function fetchText(url){ const r=await fetch(url+(url.includes('?')?'&':'?')+'cb='+Date.now()); if(!r.ok) throw new Error(r.status); return r.text(); }

    function parseCSV(text){
      const rows=[]; let i=0,cell='',row=[],inQ=false;
      const pushCell=()=>{row.push(cell);cell='';}, pushRow=()=>{rows.push(row);row=[];};
      while(i<text.length){ const ch=text[i];
        if(inQ){ if(ch=='"'){ if(text[i+1]=='"'){cell+='"';i++;} else inQ=false; } else cell+=ch; }
        else{ if(ch=='"') inQ=true; else if(ch==',') pushCell();
          else if(ch=='\n'||ch=='\r'){ if(cell.length||row.length){pushCell();pushRow();} while(text[i+1]=='\n'||text[i+1]=='\r') i++; }
          else cell+=ch; }
        i++;
      }
      if(cell.length||row.length){ pushCell(); pushRow(); }
      const head = rows.shift()||[];
      return rows.map(r=>Object.fromEntries(head.map((h,idx)=>[h.trim().replace(/^\uFEFF/,''),(r[idx]??'').trim()])));
    }

    const LIKERT = {
      'strongly disagree':1,'disagree':2,'neither agree nor disagree':3,'neutral':3,'agree':4,'strongly agree':5,
      'very dissatisfied':1,'dissatisfied':2,'neither satisfied nor dissatisfied':3,'satisfied':4,'very satisfied':5,
      'extremely unvalued':1,'somewhat unvalued':2,'somewhat valued':4,'extremely valued':5,
      'extremely not confident':1,'somewhat not confident':2,'neutral confidence':3,'somewhat confident':4,'extremely confident':5
    };
    function toScore(v){
      if(v==null) return null;
      const t=String(v).trim(); if(!t) return null;
      const n=Number(t); if(!Number.isNaN(n)&&n>=1&&n<=5) return n;
      const key=t.toLowerCase().replace(/[^a-z ]+/g,' ').replace(/\s+/g,' ').trim();
      return LIKERT[key] ?? null;
    }
    const BLACKLIST = /(^(id|email|name)$)|start|completion|timestamp|time/i;
    function detectColumns(rows){
      const headers = rows.length? Object.keys(rows[0]) : [];
      let best={col:null,rate:0};
      for(const h of headers){
        if(BLACKLIST.test(h)) continue;
        const hits=rows.reduce((n,r)=> n+(toScore(r[h])!=null?1:0),0);
        const rate=rows.length? hits/rows.length : 0;
        if(rate>best.rate) best={col:h,rate};
      }
      const scoreCol=best.rate>=0.6?best.col:null;
      const textCol=headers.find(h=>/comment|free|text|feedback/i.test(h))||null;
      return {scoreCol,textCol};
    }
    function median(arr){ if(!arr.length) return 0; const s=[...arr].sort((a,b)=>a-b); const m=Math.floor(s.length/2); return s.length%2? s[m] : (s[m-1]+s[m])/2; }

    /* ------------ load datasets ------------ */
    let ALL=[], CURRENT_ID=null;

    function normalizeIndex(index){
      const base = Array.isArray(index)? index
        : Array.isArray(index.surveys)? index.surveys
        : Array.isArray(index.datasets)? index.datasets.map(d=>({id:d.id,title:d.title||d.id,csv:(Array.isArray(d.files)&&d.files[0])?d.files[0]:"",answerColumn:d.answerColumn||d.answer||"",textColumn:d.textColumn||d.text||""}))
        : [];
      return base.map(d=>({ id:d.id, title:d.title||d.id, csv:d.csv||"", answerColumn:d.answerColumn||"", textColumn:d.textColumn||"" }));
    }

    async function loadAll(){
      const defs = normalizeIndex(await fetchJSON('data/datasets.json'));
      const out=[];
      for(const def of defs){
        if(!def.csv) continue;
        const text = await fetchText(def.csv);
        const rows = parseCSV(text);
        const auto = detectColumns(rows);
        const headers = rows.length? Object.keys(rows[0]) : [];
        const scoreCol = (def.answerColumn && headers.includes(def.answerColumn)) ? def.answerColumn : auto.scoreCol;
        const textCol  = (def.textColumn   && headers.includes(def.textColumn))   ? def.textColumn   : auto.textCol;
        out.push({ id:def.id, title:def.title||def.id, csv:def.csv, rows, scoreCol, textCol });
      }
      ALL = out;
      if(!CURRENT_ID || !ALL.some(s=>s.id===CURRENT_ID)) CURRENT_ID = ALL[0]?.id || null;
      buildSelects();
    }

    /* ------------ summarise ------------ */
    function roundPercentsTo100(counts){
      const total = counts.reduce((a,b)=>a+b,0) || 0;
      if(!total) return counts.map(()=>0);
      const raw = counts.map(c => 100*c/total);
      const floored = raw.map(Math.floor);
      let remainder = 100 - floored.reduce((a,b)=>a+b,0);
      const fracIdx = raw.map((v,i)=>({i,f:v-Math.floor(v)})).sort((a,b)=>b.f-a.f).map(x=>x.i);
      const result = [...floored];
      for(let k=0;k<remainder;k++) result[fracIdx[k%fracIdx.length]]++;
      return result;
    }

    function summarise(s){
      const scores=[], texts=[];
      for(const r of s.rows){
        const v=s.scoreCol? toScore(r[s.scoreCol]) : null;
        if(v!=null) scores.push(v);
        if(s.textCol && r[s.textCol]) texts.push(r[s.textCol]);
      }
      const total=s.rows.length, scored=scores.length;
      const avg=scored? scores.reduce((a,b)=>a+b,0)/scored : 0;
      const med=scored? median(scores) : 0;
      const posPct=scored? Math.round(100*scores.filter(v=>v>=4).length/scored) : 0;
      const negPct=scored? Math.round(100+scores.filter(v=>v<=2).length/scored)-100 : 0; // keep integers
      const counts=[1,2,3,4,5].map(v=>scores.filter(x=>x===v).length);
      const perc = roundPercentsTo100(counts);
      const dist=[1,2,3,4,5].map((v,i)=>({score:v, n:counts[i], p:perc[i]}));
      return { id:s.id,title:s.title,total,scored,avg,med,posPct,negPct,dist,texts };
    }
    function summariseAll(){ return ALL.map(s=>summarise(s)); }

    /* ------------ UI + charts ------------ */
    let chLikert, chDelta;

    function buildSelects(){
      const sel=$('#surveySelect'), cmp=$('#compareSelect');
      const prev=sel.value;
      sel.innerHTML=""; cmp.innerHTML="";
      ALL.forEach(s=>{
        sel.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.title}</option>`);
        cmp.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.title}</option>`);
      });
      sel.value = ALL.some(s=>s.id===prev)? prev : (CURRENT_ID||ALL[0]?.id||"");
      cmp.value = ALL.find(s=>s.id!==sel.value)?.id || ALL[0]?.id || "";
      CURRENT_ID = sel.value;

      $('#compareSelect').disabled = !$('#compareToggle').checked;
      $('#comparePanel').classList.toggle('hide', !$('#compareToggle').checked);

      // re-order sections when compare is ON
      reorderForCompare();
    }

    function fillKPIs(a){
      $('#kpi-total').textContent = a.total;
      $('#kpi-avg').textContent = a.avg? a.avg.toFixed(2) : "–";
      $('#kpi-pos').textContent = a.posPct + "%";
      $('#kpi-neg').textContent = a.negPct + "%";
      $('#kpi-scored').textContent = a.scored;
      $('#kpi-med').textContent = a.med? (Number.isInteger(a.med)? a.med : a.med.toFixed(1)) : "–";
      $('#kpi-neu').textContent = (a.dist[2]?.p ?? 0) + "%";
      $('#kpi-scored-note').textContent = "n=" + a.scored;
      $('#kpi-smalln').classList.toggle('hide', !(a.scored>0 && a.scored<30));

      const extremes = [];
      if(a.dist[0].n) extremes.push(`<span class="chip bad">${a.dist[0].n} × score 1</span>`);
      if(a.dist[1].n) extremes.push(`<span class="chip bad">${a.dist[1].n} × score 2</span>`);
      if(a.dist[4].n) extremes.push(`<span class="chip good">${a.dist[4].n} × score 5</span>`);
      $('#kpi-flags').innerHTML = extremes.join(' ') || '—';
    }

    function fillPlainSummary(a){
      const pos=a.posPct, neg=a.negPct, neu=(a.dist[2]?.p||0);
      $('#plainSummary').innerHTML =
        `Out of <b>${a.total}</b> responses, <b>${pos}%</b> are positive (4–5), <b>${neu}%</b> neutral (3), and <b>${neg}%</b> negative (1–2). `
        + `Average is <b>${a.avg.toFixed(2)}</b> (median ${Number.isInteger(a.med)?a.med:a.med.toFixed(1)}).`;

      // Data-responsive quick actions
      const actions=[];
      if(pos < 60) actions.push("Run a short focus group to understand low sentiment.");
      if(neg >= 25) actions.push("Follow up with the bottom-scoring group confidentially.");
      if(neu >= 20) actions.push("Probe why many are neutral; clarify expectations or supports.");
      const lowTailPct = (a.dist[0]?.p||0) + (a.dist[1]?.p||0);
      if(lowTailPct >= 10) actions.push("Escalate risks: review issues behind scores 1–2.");
      if(a.scored > 0 && a.scored < 30) actions.push("Interpret with caution; widen the sample before acting.");

      const qaWrap = document.getElementById('quickActionsBox');
      const qa = document.getElementById('quickActions');
      if(actions.length){
        qa.innerHTML = actions.slice(0,3).map(x=>`<li>${x}</li>`).join('');
        qaWrap.style.display = 'block';
      }else{
        qa.innerHTML = '';
        qaWrap.style.display = 'none';
      }
    }

    /* Themes → chips; quotes → grid */
    function getTopTerms(texts, k=7){
      const stop=new Set("the,and,to,of,in,for,a,on,is,are,it,with,that,this,at,as,be,or,we,our,your,i,have,has,was,were,from,by,an,you,they,them,not,sure,very,more,less,also".split(','));
      const freq={};
      texts.forEach(t=>{
        t.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).forEach(w=>{
          if(!w||stop.has(w)||w.length<3) return; freq[w]=(freq[w]||0)+1;
        });
      });
      return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,k).map(([label,count])=>({label,count}));
    }

    function themesAndQuotes(texts){
      const top=getTopTerms(texts||[],6);
      const chips = top.length ? top.map(t=>`<span class="theme-chip">${t.label} (${t.count})</span>`).join('') : '—';
      $('#themeChips').innerHTML = chips;

      const grid = $('#quoteGrid');
      grid.innerHTML = '';
      const quotes = [];
      // Collect up to 4 quotes related to top themes
      for(const theme of top){
        for(const q of (texts||[])){
          if(q.toLowerCase().includes(theme.label) && !quotes.includes(q)){
            quotes.push(q);
            if(quotes.length>=4) break;
          }
        }
        if(quotes.length>=4) break;
      }
      if(!quotes.length){ grid.innerHTML = '<div class="muted">No free-text comments.</div>'; return; }
      quotes.slice(0,4).forEach(q=>{
        const div=document.createElement('div');
        div.className='quote-card';
        div.innerHTML = `<p>“${q.replace(/"/g,'&quot;')}”</p>`;
        grid.appendChild(div);
      });
    }

    function fillTable(dist){
      $('#scoreTable').innerHTML = dist.map(d=>`<tr><td>${d.score}</td><td>${d.n}</td><td>${d.p}%</td></tr>`).join('');
    }

    function drawLikert(dist){
      const ds = dist.map((d,i)=>({ label:String(i+1), data:[d.n], backgroundColor:palette5[i], stack:'x' }));
      const ctx = document.getElementById('likertBar');
      if(chLikert) chLikert.destroy();
      chLikert = new Chart(ctx,{ type:'bar', data:{ labels:[''], datasets:ds },
        options:{ indexAxis:'y', scales:{ x:{stacked:true,beginAtZero:true,ticks:{precision:0}}, y:{stacked:true} }, plugins:{legend:{position:'bottom'}} }
      });
      const cap = dist.map(d=>`${d.score}: ${d.n} (${d.p}%)`).join(' • ');
      $('#likertCaption').textContent = cap;
    }

    /* ------------ Compare utilities ------------ */
    function cdfStandardNormal(z){
      const t = 1 / (1 + 0.2316419 * Math.abs(z));
      const d = 0.3989423 * Math.exp(-z*z/2);
      const p = d * t * (0.3193815 + t*(-0.3565638 + t*(1.781478 + t*(-1.821256 + t*1.330274))));
      return z>=0 ? 1-p : p;
    }
    function twoPropP(p1, n1, p2, n2){
      if(n1===0 || n2===0) return 1;
      const phat = (p1*n1 + p2*n2) / (n1+n2);
      const se = Math.sqrt(phat*(1-phat)*(1/n1 + 1/n2));
      if(se===0) return 1;
      const z = (p1 - p2) / se;
      const p = 2 * (1 - cdfStandardNormal(Math.abs(z)));
      return p;
    }
    function fmtPP(x){ const s = (x>=0?'+':'')+Math.round(x)+' pp'; const cls = x>0?'good':(x<0?'bad':''); return `<span class="chip ${cls}">${s}</span>`; }
    function fmtDelta(x, dp=2){ const s=(x>=0?'+':'')+x.toFixed(dp); const cls=x>0?'good':(x<0?'bad':''); return `<span class="chip ${cls}">${s}</span>`; }
    function fmtMed(m){ return Number.isInteger(m)? m : m.toFixed(1); }
    function escapeQuote(s){ return (s||'').replace(/"/g,'&quot;'); }

    function buildToplineTable(a,b){
      const p1 = a.posPct/100, p2 = b.posPct/100;
      const pval = twoPropP(p1,a.scored,p2,b.scored);
      const dPosBA = (b.posPct - a.posPct);
      const dNegBA = (b.negPct - a.negPct);
      const meaningful = (Math.abs(dPosBA) >= 5) && (pval < 0.05);
      const sigBadge = meaningful ? `<span class="badge ${dPosBA>=0?'ok':'risk'}">${dPosBA>=0?'meaningful ↑':'meaningful ↓'}</span>` : `<span class="badge smalln">small/uncertain</span>`;

      const warnA = (a.scored>0 && a.scored<30) ? `<span class="badge smalln">small n</span>` : '';
      const warnB = (b.scored>0 && b.scored<30) ? `<span class="badge smalln">small n</span>` : '';

      const html = `
        <tr>
          <th>Metric</th><th>${a.title}<div class="muted">n=${a.scored}</div>${warnA}</th><th>${b.title}<div class="muted">n=${b.scored}</div>${warnB}</th><th>Δ (B−A)</th><th>Meaningfulness</th>
        </tr>
        <tr><td>% Positive (4–5)</td><td>${a.posPct}%</td><td>${b.posPct}%</td><td>${fmtPP(dPosBA)}</td><td>${sigBadge}</td></tr>
        <tr><td>% Negative (1–2)</td><td>${a.negPct}%</td><td>${b.negPct}%</td><td>${fmtPP(dNegBA)}</td><td>${Math.abs(dNegBA)>=5?'large change':'—'}</td></tr>
        <tr><td>Median</td><td>${fmtMed(a.med)}</td><td>${fmtMed(b.med)}</td><td>${fmtDelta(b.med - a.med)}</td><td>descriptive</td></tr>
        <tr><td>Average</td><td>${a.avg.toFixed(2)}</td><td>${b.avg.toFixed(2)}</td><td>${fmtDelta(b.avg - a.avg,2)}</td><td>descriptive</td></tr>`;
      $('#cmpTopline').innerHTML = html;
      return {dPosBA, dNegBA, meaningful};
    }

    function drawDeltaDistribution(a,b){
      const delta = [0,1,2,3,4].map(i => (b.dist[i].p - a.dist[i].p)); // in pp
      const ctx = document.getElementById('likertDelta');
      if(chDelta) chDelta.destroy();
      chDelta = new Chart(ctx, {
        type:'bar',
        data:{ labels:['1','2','3','4','5'], datasets:[{label:'Δ pp (B−A)', data:delta, backgroundColor:delta.map(v=> v>=0 ? '#9ae6b4' : '#fecaca')}]},
        options:{ scales:{ y:{ beginAtZero:true, ticks:{ callback:val=>val+' pp'} } }, plugins:{legend:{display:false}} }
      });
    }

    function buildThemeDrift(a,b){
      const A = getTopTerms(a.texts||[],8).map(t=>t.label);
      const B = getTopTerms(b.texts||[],8).map(t=>t.label);
      const both = A.filter(x=>B.includes(x));
      const onlyA = A.filter(x=>!B.includes(x));
      const onlyB = B.filter(x=>!A.includes(x));
      $('#cmpThemes').innerHTML =
        `<div><b>Both:</b> ${both.join(', ') || '—'}</div>
         <div style="margin-top:6px"><b>New in ${b.title}:</b> ${onlyB.join(', ') || '—'}</div>
         <div style="margin-top:6px"><b>Dropped since ${a.title}:</b> ${onlyA.join(', ') || '—'}</div>`;

      const quotes=[];
      for(const t of onlyB){ const q=(b.texts||[]).find(x=>x.toLowerCase().includes(t)); if(q){ quotes.push(`“${escapeQuote(q)}”`); if(quotes.length>=2) break; } }
      if(quotes.length<2){
        for(const t of both){ const q=(b.texts||[]).find(x=>x.toLowerCase().includes(t)); if(q){ quotes.push(`“${escapeQuote(q)}”`); if(quotes.length>=2) break; } }
      }
      $('#cmpQuotes').innerHTML = quotes.length ? quotes.map(q=>`<li>${q}</li>`).join('') : '<li>No representative quotes.</li>';
    }

    function buildNarrative(a,b,stats){
      const dir = (x)=> x>0?'increased':'decreased';
      const mag = (x)=> Math.abs(Math.round(x));
      const qual = stats.meaningful ? 'meaningfully' : 'slightly';
      const medChange = a.med===b.med ? 'are unchanged' : `moved from ${fmtMed(a.med)} to ${fmtMed(b.med)}`;
      const main = `Compared with <b>${a.title}</b> (n=${a.scored}), <b>${b.title}</b> (n=${b.scored}) shows <b>${dir(stats.dPosBA)}</b> positive responses by <b>${mag(stats.dPosBA)} pp</b> ${stats.meaningful?`(${qual})`:''} and ${dir(stats.dNegBA)} negatives by ${mag(stats.dNegBA)} pp. Medians ${medChange}.`;
      const caution = (a.scored<30 || b.scored<30) ? ' <span class="badge smalln">small n — interpret cautiously</span>.' : '';
      $('#cmpNarrative').innerHTML = main + caution;
    }

    /* ------------ COPY + DOWNLOAD ------------ */
    function buildCopyText(){
      const sel = $('#surveySelect').value;
      const per = summariseAll();
      const cur = per.find(x=>x.id===sel) || per[0];
      const neu = cur.dist[2]?.p || 0;

      const items = Array.from(document.querySelectorAll('#quickActions li')).map(li=>`- ${li.textContent}`);
      const lines = [
        `${cur.title} — topline`,
        `Responses: ${cur.total} (scored n=${cur.scored})`,
        `Average ${cur.avg.toFixed(2)} (median ${Number.isInteger(cur.med)?cur.med:cur.med.toFixed(1)})`,
        `Positive: ${cur.posPct}% • Neutral: ${neu}% • Negative: ${cur.negPct}%`,
        `Distribution: ${cur.dist.map(d=>`${d.score}=${d.n}(${d.p}%)`).join(', ')}`
      ];
      if(items.length){
        lines.push("", "Quick actions:", ...items);
      }
      return lines.join('\n');
    }

    async function copySummary(){
      const text = buildCopyText();
      try{
        await navigator.clipboard.writeText(text);
        $('#btnCopySummary').textContent = 'Copied!';
        setTimeout(()=>$('#btnCopySummary').textContent='Copy summary',1200);
      }catch{
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); }catch{}
        document.body.removeChild(ta);
        $('#btnCopySummary').textContent = 'Copied!';
        setTimeout(()=>$('#btnCopySummary').textContent='Copy summary',1200);
      }
    }

    function buildWordText(){
      const sel = $('#surveySelect').value;
      const per = summariseAll();
      const cur = per.find(x=>x.id===sel) || per[0];
      const neu = cur.dist[2]?.p || 0;
      const items = Array.from(document.querySelectorAll('#quickActions li')).map(li=>`- ${li.textContent}`);

      const base = [
        `Survey: ${cur.title}`,
        `Responses: ${cur.total} (scored n=${cur.scored})`,
        `Avg ${cur.avg.toFixed(2)} | Median ${Number.isInteger(cur.med)?cur.med:cur.med.toFixed(1)}`,
        `Positive 4–5: ${cur.posPct}% | Neutral 3: ${neu}% | Negative 1–2: ${cur.negPct}%`,
        `Distribution: ${cur.dist.map(d=>`${d.score}=${d.n}(${d.p}%)`).join(', ')}`
      ];
      if(items.length){
        base.push("", "Suggested actions:", ...items);
      }
      return base.join('\n');
    }

    async function copyToWord(){
      const text = buildWordText();
      try{
        await navigator.clipboard.writeText(text);
        $('#btnCopyWord').textContent = 'Copied!';
        setTimeout(()=>$('#btnCopyWord').textContent='Copy to Word',1200);
      }catch(e){ alert("Copy failed: " + e.message); }
    }

    function downloadLikertPNG(){
      if(!window.chLikert) return;
      const link = document.createElement('a');
      link.download = `${$('#surveySelect').value || 'survey'}-likert.png`;
      link.href = chLikert.toBase64Image();
      link.click();
    }

    /* ------------ COPILOT-READY EXPORT ------------ */
    function safeName(s){ return (s||'survey').replace(/[^a-z0-9]+/gi,'_'); }
    function makePromptsSheet(cur, compare){
      const base = [
        ["Try asking Copilot (paste these into the Copilot box in Excel/Teams):"],
        [""],
        ["Summarise this survey in 5 bullets. Use only the numbers in the Topline and Distribution sheets. End with 3 recommended actions."],
        ["Highlight the biggest positives and biggest risks in one paragraph, citing the Topline numbers."],
        ["Create a bar chart of the Distribution and explain what it shows in 2 sentences."]
      ];
      if(compare){
        base.push(
          [""],
          ["Compare the current survey with the Compare sheet. Report change in average and change in % positive (percentage points). If change ≥ 5pp, suggest one likely reason using anonymised comments."]
        );
      }
      return XLSX.utils.aoa_to_sheet(base);
    }

    function exportToExcel(){
      const sel = $('#surveySelect').value;
      const per = summariseAll();
      const cur = per.find(x=>x.id===sel) || per[0];

      const topline = [
        [cur.title, "Topline"],
        ["Responses", cur.total],
        ["Scored (n)", cur.scored],
        ["Average", Number(cur.avg.toFixed(2))],
        ["Median", Number.isInteger(cur.med)?cur.med:Number(cur.med.toFixed(1))],
        ["Positive (4–5)", cur.posPct/100],
        ["Neutral (3)", (cur.dist[2]?.p||0)/100],
        ["Negative (1–2)", cur.negPct/100]
      ];
      const wsTop = XLSX.utils.aoa_to_sheet(topline);
      ['B6','B7','B8'].forEach(c=>{ if(wsTop[c]) wsTop[c].z='0%'; });

      const wsDist = XLSX.utils.aoa_to_sheet([["Score","Count","Percent"], ...cur.dist.map(d=>[d.score,d.n,d.p/100])]);
      for(let r=2;r<=6;r++){ const cell=`C${r}`; if(wsDist[cell]) wsDist[cell].z='0%'; }

      const sDef = ALL.find(s=>s.id===cur.id);
      const rows = (sDef?.rows || []).map(r=>{
        const sc = sDef?.scoreCol ? toScore(r[sDef.scoreCol]) : null;
        const tx = sDef?.textCol ? r[sDef.textCol] : "";
        return { "Score (1-5)": sc, "Comment": tx || "" };
      });
      const wsResp = XLSX.utils.json_to_sheet(rows, { header:["Score (1-5)","Comment"] });

      const compareOn = $('#compareToggle').checked && ALL.length>1;
      let wsCmp = null;
      if(compareOn){
        const other = per.find(x=>x.id === $('#compareSelect').value && x.id!==cur.id) || per.find(x=>x.id!==cur.id) || cur;
        const cmpAoA = [
          ["Metric", cur.title, other.title],
          ["Average", Number(cur.avg.toFixed(2)), Number(other.avg.toFixed(2))],
          ["% Positive (4–5)", cur.posPct/100, other.posPct/100]
        ];
        wsCmp = XLSX.utils.aoa_to_sheet(cmpAoA);
        ['B3','C3'].forEach(c=>{ if(wsCmp[c]) wsCmp[c].z='0%'; });
      }

      const wsPrompts = makePromptsSheet(cur, !!wsCmp);

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, wsTop, "Topline");
      XLSX.utils.book_append_sheet(wb, wsDist, "Distribution");
      XLSX.utils.book_append_sheet(wb, wsResp, "Responses (anonymised)");
      if(wsCmp) XLSX.utils.book_append_sheet(wb, wsCmp, "Compare");
      XLSX.utils.book_append_sheet(wb, wsPrompts, "Prompts");

      XLSX.writeFile(wb, `${safeName(cur.title)}_Copilot.xlsx`);
    }

    /* ------------ Copilot prompt copier ------------ */
    function buildCopilotPrompt(){
      const sel = $('#surveySelect').value;
      const per = summariseAll();
      const cur = per.find(x=>x.id===sel) || per[0];
      const compareOn = $('#compareToggle').checked && ALL.length>1;
      const other = compareOn
        ? (per.find(x=>x.id === $('#compareSelect').value && x.id!==cur.id) || per.find(x=>x.id!==cur.id))
        : null;

      const lines = [];
      lines.push("You are Copilot in Excel. Using only the numbers in this workbook:");
      lines.push(`1) Summarise "${cur.title}" in 5 bullets using Topline and Distribution. Include average, % positive, % negative, and 1–2 notable distribution points.`);
      if(other){
        lines.push(`2) Compare "${cur.title}" with "${other.title}". Report change in average and change in % positive in percentage points. If change ≥ 5pp, suggest a likely reason using comments from the Responses (anonymised) sheet.`);
      }
      lines.push("3) List 3 clear recommended actions for the next cycle.");
      lines.push("4) Create a chart that best shows the distribution and insert it here.");
      return lines.join("\n");
    }

    async function copyCopilotPrompt(){
      const text = buildCopilotPrompt();
      try{
        await navigator.clipboard.writeText(text;
        );
        $('#btnCopyCopilot').textContent = 'Prompt copied!';
        setTimeout(()=>$('#btnCopyCopilot').textContent='Copy Copilot prompt',1200);
      }catch{
        const ta = document.createElement('textarea'); ta.value = text;
        document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch{}
        document.body.removeChild(ta);
        $('#btnCopyCopilot').textContent = 'Prompt copied!';
        setTimeout(()=>$('#btnCopyCopilot').textContent='Copy Copilot prompt',1200);
      }
    }

    /* ------------ reorder / refresh pipeline ------------ */
    function reorderForCompare(){
      const on = $('#compareToggle').checked;
      const compare = $('#comparePanel');
      const distribution = $('#distributionPanel');

      if(on){
        // Move compare card to sit immediately before the distribution card (keep both visible)
        const parent = distribution.parentNode;
        if(parent && parent.children){
          if(compare && compare.nextElementSibling !== distribution){
            parent.insertBefore(compare, distribution);
          }
          compare.classList.remove('hide');
        }
      }else{
        // Hide compare; distribution remains where it is
        compare.classList.add('hide');
      }
    }

    function refresh(){
      if(!ALL.length) return;
      const per = summariseAll();
      const cur = per.find(x=>x.id===CURRENT_ID) || per[0];

      fillKPIs(cur);
      fillTable(cur.dist);
      drawLikert(cur.dist);
      fillPlainSummary(cur);
      themesAndQuotes(cur.texts || []);

      const compareOn = $('#compareToggle').checked && ALL.length>1;
      $('#comparePanel').classList.toggle('hide', !compareOn);
      $('#compareSelect').disabled = !compareOn;

      reorderForCompare();

      if(compareOn){
        const other = per.find(x=>x.id === $('#compareSelect').value && x.id!==cur.id) || per.find(x=>x.id!==cur.id) || cur;
        const stats = buildToplineTable(cur, other);
        drawDeltaDistribution(cur, other);
        buildThemeDrift(cur, other);
        buildNarrative(cur, other, stats);
      }
    }

    /* ------------ events ------------ */
    $('#surveySelect').addEventListener('change', e=>{ CURRENT_ID=e.target.value; refresh(); });
    $('#compareToggle').addEventListener('change', ()=>{ buildSelects(); refresh(); });
    $('#compareSelect').addEventListener('change', refresh);
    $('#btnRefresh').addEventListener('click', async ()=>{ await loadAll(); refresh(); });

    $('#btnCopySummary').addEventListener('click', copySummary);
    $('#btnDownloadLikert').addEventListener('click', downloadLikertPNG);
    $('#btnExportExcel').addEventListener('click', exportToExcel);
    $('#btnCopyCopilot').addEventListener('click', copyCopilotPrompt);
    $('#btnCopyWord').addEventListener('click', copyToWord);

    $('#toggleDetail').addEventListener('click', ()=>{
      const box = $('#kpiDetail');
      const open = box.style.display === 'block';
      box.style.display = open ? 'none' : 'block';
      $('#toggleDetail').textContent = open ? 'more detail' : 'hide detail';
    });

    /* ------------ boot ------------ */
    (async function init(){
      try{ await loadAll(); buildSelects(); refresh(); }
      catch(e){ console.error(e); alert("Failed to load data. Check datasets.json and CSV paths."); }
    })();
  </script>
</body>
</html>
