<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>I-REACCH | Dashboard</title>

  <!-- your site styles -->
  <link rel="stylesheet" href="assets/css/brand.css"/>
  <link rel="stylesheet" href="assets/css/header.css"/>
  <link rel="stylesheet" href="assets/css/style.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --page-max:1200px;
      --border:#e6ecf1; --text:#1b2a41; --muted:#556070;
      --band:#cfe4e7; --white:#fff;
      --grad-a:#4a1ea8; --grad-b:#0aa0ff;
      --good:#22a06b; --bad:#d14d4d;
    }
    .hero-slab{background:var(--band);padding:28px 0 22px;border-bottom:1px solid #c3d6d9}
    .wrap{max-width:var(--page-max);margin:0 auto;padding:0 24px}
    @media (max-width:640px){.wrap{padding:0 16px}}
    .h1{font-weight:800;margin:0;font-size:clamp(1.6rem,2.6vw,2.1rem)}
    .sub{color:var(--muted);margin-top:6px}
    .grid-2{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media (max-width:1080px){.grid-2{grid-template-columns:1fr}}
    .panel{background:var(--white);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(28,39,51,.04)}
    .pad{padding:18px}
    .kpis{display:flex;gap:18px;flex-wrap:wrap;font-weight:800}
    .kpi{display:flex;flex-direction:column}
    .kpi .v{font-size:clamp(1.05rem,2vw,1.3rem)}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:800;color:#fff;background:linear-gradient(90deg,var(--grad-a),var(--grad-b));cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .h2{font-weight:800;margin:0 0 10px;font-size:clamp(1.3rem,2.2vw,1.6rem)}
    .mini-grid{display:grid;grid-template-columns:260px 1fr;gap:18px}
    @media (max-width:980px){.mini-grid{grid-template-columns:1fr}}
    .mini-table{border-collapse:collapse;border:2px solid #2e4b6a;border-radius:8px;overflow:hidden;width:100%}
    .mini-table th,.mini-table td{border:2px solid #2e4b6a;padding:8px 10px;text-align:center;font-weight:700}
    .ai-box{border:1px solid var(--border);border-radius:12px;padding:14px 16px;background:#fff}
    .ai-small{color:var(--muted);font-size:.95rem}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spacer{height:10px}
    canvas{max-width:100%}
    .pill{font-size:.85rem;background:#eef2f7;color:#556070;padding:4px 10px;border-radius:999px;font-weight:700}
    select.pill{appearance:auto}
    .hint{font-size:.9rem;color:var(--muted)}
    .delta{font-weight:800;padding:.15rem .5rem;border-radius:999px}
    .delta.up{background:#eaf7f1;color:var(--good)}
    .delta.down{background:#fdecec;color:var(--bad)}
    .right{margin-left:auto}
    .hide{display:none}
  </style>
</head>
<body>
  <!-- header -->
  <header class="hero-slab">
    <div class="wrap">
      <h1 class="h1">Dashboard <span class="pill">beta</span></h1>
      <div class="sub">Clear, reproducible summaries of each micro-survey — with optional AI text on top of exact numbers.</div>
    </div>
  </header>

  <main class="wrap" style="margin:20px auto 40px">
    <!-- controls + KPIs -->
    <section class="panel pad" style="margin-bottom:18px">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill">Dataset</span>
          <select id="surveySelect" class="pill"></select>
          <label class="pill" style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="compareToggle"> compare
          </label>
          <select id="compareSelect" class="pill" disabled></select>
        </div>
        <div class="row">
          <button id="btnRefresh" class="btn ghost">Reload data</button>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><div class="muted">Responses (total)</div><div class="v" id="kpi-total">–</div></div>
        <div class="kpi"><div class="muted">Scored</div><div class="v" id="kpi-scored">–</div></div>
        <div class="kpi"><div class="muted">Blanks</div><div class="v" id="kpi-blank">–</div></div>
        <div class="kpi"><div class="muted">Avg. score</div><div class="v" id="kpi-avg">–</div></div>
        <div class="kpi"><div class="muted">Median</div><div class="v" id="kpi-med">–</div></div>
        <div class="kpi"><div class="muted">Positive (4–5)</div><div class="v" id="kpi-pos">–</div></div>
        <div class="kpi"><div class="muted">Negative (1–2)</div><div class="v" id="kpi-neg">–</div></div>
        <div class="kpi right"><div class="muted">Notes</div><div class="v" id="kpi-note" style="font-weight:600"></div></div>
      </div>
      <div class="hint" style="margin-top:8px">
        Data source: <code>data/datasets.json</code> + CSVs (same origin). We compute numbers deterministically and let AI summarise in words.
      </div>
    </section>

    <!-- distribution + themes -->
    <section class="grid-2" style="margin-bottom:18px">
      <div class="panel pad">
        <h2 class="h2">Response distribution</h2>
        <div class="mini-grid">
          <table class="mini-table">
            <thead><tr><th>Score</th><th>Count</th><th>%</th></tr></thead>
            <tbody id="scoreTable"></tbody>
          </table>
          <div>
            <canvas id="likertBar" height="200" aria-label="Likert distribution"></canvas>
          </div>
        </div>
      </div>

      <aside class="panel pad">
        <h2 class="h2">Top themes</h2>
        <div id="themeList" class="ai-small">–</div>
        <div class="spacer"></div>
        <div class="muted">Examples</div>
        <ul id="themeQuotes" class="ai-small" style="margin:.2rem 0 0 1rem"></ul>
      </aside>
    </section>

    <!-- compare -->
    <section id="comparePanel" class="panel pad hide" style="margin-bottom:18px">
      <div class="row" style="justify-content:space-between">
        <h2 class="h2" style="margin:0">Compare</h2>
        <div class="row">
          <div class="pill">Δ Avg <span id="delta-avg" class="delta" style="margin-left:6px">–</span></div>
          <div class="pill">Δ Positive <span id="delta-pos" class="delta" style="margin-left:6px">–</span></div>
        </div>
      </div>
      <canvas id="likertCompare" height="220"></canvas>
    </section>

    <!-- AI Insights -->
    <section class="panel pad">
      <h2 class="h2">AI insights</h2>
      <div class="row">
        <input id="aiPrompt" class="pill" style="padding:10px 12px;width:min(680px,100%)" placeholder="Ask AI about these results (e.g., ‘key risks by theme?’)"/>
        <button id="btnExplain" class="btn">Generate insights</button>
      </div>
      <div class="spacer"></div>
      <div id="aiOut" class="ai-box" style="display:none">
        <div class="ai-small" id="aiSummary"></div>
        <div class="ai-small" id="aiActions" style="margin-top:8px"></div>
      </div>
    </section>
  </main>

  <script>
    /* ---------------- utilities ---------------- */
    const $ = s => document.querySelector(s);
    const palette5 = ["#c7d2fe","#a5b4fc","#818cf8","#6366f1","#4f46e5"]; // 1..5
    const neutral = ["rgba(71,118,230,.9)","rgba(137,196,244,.9)","rgba(59,173,227,.9)","rgba(130,177,255,.9)","rgba(171,204,255,.9)"];

    async function fetchJSON(url){ const r=await fetch(url+(url.includes('?')?'&':'?')+'cb='+Date.now()); if(!r.ok) throw new Error(r.status); return r.json(); }
    async function fetchText(url){ const r=await fetch(url+(url.includes('?')?'&':'?')+'cb='+Date.now()); if(!r.ok) throw new Error(r.status); return r.text(); }

    // tiny CSV parser (quoted commas)
    function parseCSV(text){
      const rows=[]; let i=0,cell='',row=[],inQ=false;
      const pushCell=()=>{row.push(cell);cell='';}, pushRow=()=>{rows.push(row);row=[];};
      while(i<text.length){ const ch=text[i];
        if(inQ){ if(ch=='"'){ if(text[i+1]=='"'){cell+='"';i++;} else inQ=false; } else cell+=ch; }
        else{ if(ch=='"') inQ=true; else if(ch==',') pushCell();
          else if(ch=='\n'||ch=='\r'){ if(cell.length||row.length){pushCell();pushRow();} while(text[i+1]=='\n'||text[i+1]=='\r') i++; }
          else cell+=ch; }
        i++;
      }
      if(cell.length||row.length){ pushCell(); pushRow(); }
      const head = rows.shift()||[];
      return rows.map(r=>Object.fromEntries(head.map((h,idx)=>[h.trim(),(r[idx]??'').trim()])));
    }

    // Likert mapping
    const LIKERT = {
      'strongly disagree':1,'disagree':2,'neither agree nor disagree':3,'neutral':3,'agree':4,'strongly agree':5,
      'very dissatisfied':1,'dissatisfied':2,'neither satisfied nor dissatisfied':3,'satisfied':4,'very satisfied':5,
      'extremely unvalued':1,'somewhat unvalued':2,'somewhat valued':4,'extremely valued':5,
      'extremely not confident':1,'somewhat not confident':2,'neutral confidence':3,'somewhat confident':4,'extremely confident':5
    };
    function toScore(v){
      if(v==null) return null;
      const t=String(v).trim(); if(!t) return null;
      const n=Number(t); if(!Number.isNaN(n) && n>=1 && n<=5) return n;
      const key=t.toLowerCase().replace(/[^a-z ]+/g,' ').replace(/\s+/g,' ').trim();
      return LIKERT[key] ?? null;
    }

    function median(arr){ if(!arr.length) return 0; const s=[...arr].sort((a,b)=>a-b); const m=Math.floor(s.length/2); return s.length%2? s[m] : (s[m-1]+s[m])/2; }

    /* --------------- loading --------------- */
    let ALL = [];       // [{id,title,csv,rows,scoreCol,textCol}]
    let CURRENT_ID = null;

    const BLACKLIST = /(^(id|email|name)$)|start|completion|timestamp|time/i;
    function detectColumns(rows){
      const headers = rows.length? Object.keys(rows[0]) : [];
      // score column: highest hit rate of mappable 1–5, excluding blacklist; need >=60%
      let best={col:null,rate:0};
      for(const h of headers){
        if(BLACKLIST.test(h)) continue;
        const hits = rows.reduce((n,r)=> n+(toScore(r[h])!=null?1:0), 0);
        const rate = rows.length? hits/rows.length : 0;
        if(rate>best.rate){ best={col:h,rate}; }
      }
      const scoreCol = best.rate>=0.6? best.col : null;
      const textCol = headers.find(h=>/comment|free|text|feedback/i.test(h)) || null;
      return {scoreCol,textCol};
    }

    function normalizeIndex(index){
      if(Array.isArray(index)) return index;
      if(Array.isArray(index.surveys)) return index.surveys;
      if(Array.isArray(index.datasets)) return index.datasets.map(d=>({id:d.id,title:d.title||d.id,csv:(Array.isArray(d.files)&&d.files[0])?d.files[0]:""}));
      return [];
    }

    async function loadAll(){
      const defs = normalizeIndex(await fetchJSON('data/datasets.json'));
      const out=[];
      for(const def of defs){
        if(!def.csv) continue;
        const text = await fetchText(def.csv);
        const rows = parseCSV(text);
        const cols = detectColumns(rows);
        out.push({ id:def.id, title:def.title||def.id, csv:def.csv, rows, ...cols });
      }
      ALL = out;
      if(!CURRENT_ID || !ALL.some(s=>s.id===CURRENT_ID)) CURRENT_ID = ALL[0]?.id || null;
      buildSelects();
    }

    /* --------------- summarise --------------- */
    function summarise(s){
      const scores=[], texts=[];
      for(const r of s.rows){
        const v = s.scoreCol ? toScore(r[s.scoreCol]) : null;
        if(v!=null) scores.push(v);
        if(s.textCol && r[s.textCol]) texts.push(r[s.textCol]);
      }
      const total = s.rows.length;
      const scored = scores.length;
      const blanks = total - scored;
      const avg = scored ? scores.reduce((a,b)=>a+b,0)/scored : 0;
      const med = scored ? median(scores) : 0;
      const posPct = scored ? Math.round(100 * scores.filter(v=>v>=4).length / scored) : 0;
      const negPct = scored ? Math.round(100 * scores.filter(v=>v<=2).length / scored) : 0;
      const dist = [1,2,3,4,5].map(v=>({score:v, n:scores.filter(x=>x===v).length, p: scored? Math.round(100*scores.filter(x=>x===v).length/scored) : 0}));
      return {total,scored,blanks,avg,med,posPct,negPct,dist,texts};
    }

    /* --------------- UI + charts --------------- */
    let chLikert, chCompare;

    function buildSelects(){
      const sel = $('#surveySelect'), cmp = $('#compareSelect');
      const prev = sel.value, prevCmp = cmp.value;
      sel.innerHTML = ""; cmp.innerHTML = "";
      ALL.forEach(s=>{
        sel.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.title||s.id}</option>`);
        cmp.insertAdjacentHTML('beforeend', `<option value="${s.id}">${s.title||s.id}</option>`);
      });
      sel.value = ALL.some(s=>s.id===prev)? prev : (CURRENT_ID||ALL[0]?.id||"");
      cmp.value = ALL.find(s=>s.id!==sel.value)?.id || ALL[0]?.id || "";
      CURRENT_ID = sel.value;
      $('#compareSelect').disabled = !$('#compareToggle').checked;
      $('#comparePanel').classList.toggle('hide', !$('#compareToggle').checked);
    }

    function fillKpis(sum, title){
      $('#kpi-total').textContent  = sum.total;
      $('#kpi-scored').textContent = sum.scored;
      $('#kpi-blank').textContent  = sum.blanks;
      $('#kpi-avg').textContent    = sum.avg ? sum.avg.toFixed(2) : "–";
      $('#kpi-med').textContent    = sum.med ? (Number.isInteger(sum.med)? sum.med : sum.med.toFixed(1)) : "–";
      $('#kpi-pos').textContent    = sum.posPct + "%";
      $('#kpi-neg').textContent    = sum.negPct + "%";
      $('#kpi-note').textContent   = title ? title : "";
    }

    function fillTable(dist){
      $('#scoreTable').innerHTML = dist.map(d=>`<tr><td>${d.score}</td><td>${d.n}</td><td>${d.p}%</td></tr>`).join('');
    }

    function drawLikert(dist){
      const counts = dist.map(d=>d.n); // 1..5
      const dataSets = counts.map((c,i)=>({
        label:String(i+1),
        data:[c],
        backgroundColor:palette5[i],
        stack:'x'
      }));
      const ctx = document.getElementById('likertBar');
      if(chLikert) chLikert.destroy();
      chLikert = new Chart(ctx,{
        type:'bar',
        data:{ labels:[''], datasets:dataSets },
        options:{
          indexAxis:'y',
          scales:{ x:{ stacked:true, beginAtZero:true, ticks:{ precision:0 } }, y:{ stacked:true } },
          plugins:{ legend:{ position:'bottom' } }
        }
      });
    }

    function drawCompare(a,b){
      const da = a.dist.map(d=>d.n);
      const db = b.dist.map(d=>d.n);
      const ds = [0,1,2,3,4].map(i=>({
        label:String(i+1),
        data:[da[i], db[i]],
        backgroundColor:palette5[i],
        stack:'x'
      }));
      const ctx = document.getElementById('likertCompare');
      if(chCompare) chCompare.destroy();
      chCompare = new Chart(ctx,{
        type:'bar',
        data:{ labels:['Current','Compare'], datasets: ds },
        options:{ indexAxis:'y', scales:{ x:{ stacked:true, beginAtZero:true }, y:{ stacked:true } }, plugins:{ legend:{ position:'bottom' } } }
      });

      const dAvg = (a.avg - b.avg);
      const dPos = (a.posPct - b.posPct);
      const fmt = n => (n>0? '+' : '') + (Number.isInteger(n)? n : n.toFixed(2));
      const chip = (el, n) => {
        el.textContent = fmt(n);
        el.className = 'delta ' + (n>=0? 'up' : 'down');
      };
      chip($('#delta-avg'), dAvg);
      chip($('#delta-pos'), dPos);
    }

    function themesOutput(texts){
      // super-simple keyword freq + 2 example quotes
      const stop=new Set("the,and,to,of,in,for,a,on,is,are,it,with,that,this,at,as,be,or,we,our,your,i,have,has,was,were,from,by,an,you,they,them".split(','));
      const freq={};
      texts.forEach(t=>{
        t.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).forEach(w=>{
          if(!w || stop.has(w) || w.length<3) return;
          freq[w]=(freq[w]||0)+1;
        });
      });
      const top = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([label,count])=>({label,count}));
      $('#themeList').innerHTML = top.length ? top.map(t=>`<div>• <b>${t.label}</b> (${t.count})</div>`).join('') : '—';
      // naive quotes: first 2 comments containing top-1 or top-2 keywords
      const q=[];
      if(top[0]) for(const t of texts){ if(t.toLowerCase().includes(top[0].label) && q.length<2) q.push(t); }
      if(q.length<2 && top[1]) for(const t of texts){ if(t.toLowerCase().includes(top[1].label) && q.length<2) q.push(t); }
      $('#themeQuotes').innerHTML = q.length ? q.map(s=>`<li>“${s.replace(/"/g,'&quot;')}”</li>`).join('') : '';
    }

    /* --------------- interactions --------------- */
    function refresh(){
      if(!ALL.length) return;
      const cur = ALL.find(s=>s.id===CURRENT_ID) || ALL[0];
      const a = summarise(cur);
      fillKpis(a, cur.title);
      fillTable(a.dist);
      drawLikert(a.dist);
      themesOutput(a.texts||[]);

      const compareOn = $('#compareToggle').checked && ALL.length>1;
      $('#comparePanel').classList.toggle('hide', !compareOn);
      $('#compareSelect').disabled = !compareOn;
      if(compareOn){
        const otherId = $('#compareSelect').value;
        const other = ALL.find(s=>s.id===otherId && s.id!==cur.id) || ALL.find(s=>s.id!==cur.id) || cur;
        const b = summarise(other);
        drawCompare(a,b);
      }
    }

    $('#surveySelect').addEventListener('change', e=>{ CURRENT_ID = e.target.value; refresh(); });
    $('#compareToggle').addEventListener('change', ()=>{ buildSelects(); refresh(); });
    $('#compareSelect').addEventListener('change', refresh);
    $('#btnRefresh').addEventListener('click', async ()=>{ await loadAll(); refresh(); });

    // simple AI text (client-only heuristic for now)
    $('#btnExplain').addEventListener('click', ()=>{
      const cur = ALL.find(s=>s.id===CURRENT_ID) || ALL[0];
      const a = summarise(cur);
      const prompt = ($('#aiPrompt').value||'').trim();
      const bullets = [
        `${a.total} responses collected; ${a.scored} scored, ${a.blanks} blank.`,
        `Average ${a.avg.toFixed(2)} (median ${Number.isInteger(a.med)?a.med:a.med.toFixed(1)}).`,
        `${a.posPct}% positive (4–5); ${a.negPct}% negative (1–2).`,
        `Most common score: ${a.dist.sort((x,y)=>y.n-x.n)[0]?.score ?? '—'}.`
      ];
      const extra = prompt ? `Prompt: ${prompt}` : '';
      $('#aiSummary').innerHTML = bullets.map(b=>`• ${b}`).join('<br>') + (extra? `<br>${extra}` : '');
      const actions = [
        "Share a quick wins note referencing top theme.",
        "Plan a short pilot addressing the biggest friction theme.",
        "Run a pulse check after the intervention."
      ];
      $('#aiActions').innerHTML = "<b>Next actions</b><br><ul style='margin:.2rem 0 0 1rem'>"+actions.map(a=>`<li>${a}</li>`).join('')+"</ul>";
      $('#aiOut').style.display='block';
    });

    (async function init(){
      try{
        await loadAll();
        refresh();
      }catch(e){
        console.error(e);
        alert("Failed to load data. Check data/datasets.json and CSV paths.");
      }
    })();
  </script>
</body>
</html>
