<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard | I-REACCH</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="assets/css/brand.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    :root{
      --accent:#4a6cf7; --bg:#f3f7fb; --card:#fff; --border:#e6edf5; --ink:#1b2a41; --muted:#64748b;
    }
    body{background:#eaf1f7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;color:var(--ink)}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    .title{display:flex;align-items:center;gap:10px}
    .beta{font-size:12px;font-weight:800;background:#eef4ff;color:#2c5aa0;border:1px solid var(--border);padding:2px 8px;border-radius:999px}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}

    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:1.15fr .85fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:1000px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 18px rgba(18,47,76,.06)}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:900}
    .card .bd{padding:14px 16px}

    .kpis{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .kchip{font-weight:800;background:#eef4ff;border:1px solid var(--border);border-radius:999px;padding:8px 12px}
    .pill{font-weight:800;padding:6px 10px;border-radius:999px;background:#eef4ff;border:1px solid var(--border)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,button{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff}
    button{font-weight:800;background:linear-gradient(135deg,#9b51e0,#4a6cf7);color:#fff;border:0}

    table{width:100%;border-collapse:collapse}
    td,th{border-bottom:1px solid var(--border);padding:8px 10px;font-size:14px;text-align:center}
    th{text-align:left}

    .drop{border:2px dashed var(--border);border-radius:12px;padding:10px;text-align:center;color:var(--muted);font-size:13px}
    .drop.drag{background:#f7fbff}
    .ai-box{display:flex;gap:10px}
    .ai-box input{flex:1;padding:10px;border:1px solid var(--border);border-radius:10px}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1 style="margin:0">Dashboard</h1>
      <span class="beta">beta</span>
    </div>
    <div class="sub">Live view of micro-survey responses (CSV exports in your repo) + client-side insights.</div>

    <!-- KPIs + controls -->
    <div class="card" style="margin-top:16px">
      <div class="bd">
        <div class="kpis">
          <div class="kchip">Responses = <span id="kpiResponses">–</span></div>
          <div class="kchip">Avg. score = <span id="kpiAvg">–</span></div>
          <div class="kchip">Positive = <span id="kpiPos">–</span></div>

          <span class="pill">Dataset</span>
          <select id="datasetSel"></select>
          <button id="reloadBtn" title="Re-fetch current dataset">Reload data</button>
        </div>
        <div class="hint">
          Data source: <code>data/datasets.json</code> + CSVs (same origin). Supports both
          <code>{"surveys":[...]}</code> and <code>{"datasets":[...]}</code> index shapes.
        </div>
      </div>
    </div>

    <!-- themes + trend -->
    <div class="grid cols-2" style="margin-top:16px">
      <div class="card">
        <div class="hd">Top themes</div>
        <div class="bd">
          <canvas id="themesChart" height="110"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="hd">Positive trend</div>
        <div class="bd">
          <div class="muted" style="margin-bottom:6px">Monthly % positive (≥4 on a 1–5 scale)</div>
          <canvas id="trendChart" height="110"></canvas>
        </div>
      </div>
    </div>

    <!-- distribution -->
    <div class="card" style="margin-top:16px">
      <div class="hd">Overall distribution</div>
      <div class="bd">
        <div class="grid cols-3">
          <div>
            <table>
              <thead><tr><th>Score</th><th>Count</th></tr></thead>
              <tbody id="distTable"></tbody>
            </table>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Current survey</div>
            <canvas id="pieCurrent" height="150"></canvas>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">All surveys (combined)</div>
            <canvas id="pieAll" height="150"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- AI insights (placeholder; safe to wire later) -->
    <div class="card" style="margin-top:16px;margin-bottom:24px">
      <div class="hd">AI insights</div>
      <div class="bd">
        <div class="ai-box">
          <input id="aiQuestion" placeholder="Ask AI about these results (e.g., ‘key risks by theme?’)" disabled />
          <button id="aiBtn" disabled>Generate insights</button>
        </div>
        <div class="hint">Enable later with a small serverless function (Azure Functions) to call Azure OpenAI safely.</div>
      </div>
    </div>

    <!-- Drag-and-drop (optional upload mode for quick tests) -->
    <div class="drop" id="dropZone">or drop CSVs here to preview locally (upload mode)</div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
  // -------- state --------
  let DATASETS = [];          // normalized [{id,title,csv,answerColumn,textColumn}]
  let CURRENT_ID = null;      // active dataset id
  let ALL_CACHE = {};         // combined cache {id -> rows[]}
  let charts = [];            // Chart.js instances to destroy between renders

  // -------- utils --------
  async function fetchJSON(url){
    const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'cb=' + Date.now());
    return await res.json();
  }
  async function fetchText(url){
    const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'cb=' + Date.now());
    return await res.text();
  }
  function normalizeRoot(root){
    const arr = Array.isArray(root?.surveys) ? root.surveys :
                Array.isArray(root?.datasets) ? root.datasets : [];
    return arr.map(d => ({
      id: d.id,
      title: d.title || d.name || d.id,
      csv: d.csv,
      answerColumn: d.answerColumn || d.answer || "",
      textColumn: d.textColumn || d.text || ""
    }));
  }
  function getDatasetById(id){ return DATASETS.find(d => d.id === id); }

  // -------- Likert → 1–5 mapping (fixes avg=25) --------
  const LIKERT_MAP = {
    'strongly disagree':1,'disagree':2,'neither':3,'neutral':3,'agree':4,'strongly agree':5
  };
  function toScore(v){
    if (v == null) return null;
    const n = Number(v);
    if (!Number.isNaN(n) && n>=1 && n<=5) return n;
    const key = String(v).toLowerCase().replace(/[^a-z ]+/g,' ').replace(/\s+/g,' ').trim();
    return LIKERT_MAP[key] ?? null;
  }

  // -------- CSV parsing --------
  function parseCSV(text){
    const out = Papa.parse(text, { header:true, skipEmptyLines:true });
    return out.data;
  }

  // -------- column detection --------
  function detectColumns(rows, cfg){
    const cols = rows.length ? Object.keys(rows[0]) : [];
    const isDate = v => v && !isNaN(Date.parse(v));
    // score column
    let scoreCol = cfg.answerColumn && cols.includes(cfg.answerColumn)
      ? cfg.answerColumn
      : cols.find(c => rows.some(r => toScore(r[c]) != null));
    // date column
    let dateCol = cols.find(c => rows.some(r => isDate(r[c])));
    // text column
    let textCol = cfg.textColumn && cols.includes(cfg.textColumn)
      ? cfg.textColumn
      : cols.find(c => /comment|text|feedback|free/i.test(c));
    return { scoreCol, dateCol, textCol };
  }

  // -------- KPI & transforms --------
  function computeKPIs(rows, cols){
    const scores = rows.map(r => toScore(r[cols.scoreCol])).filter(x => x != null);
    const total = scores.length;
    const avg = total ? (scores.reduce((a,b)=>a+b,0) / total) : 0;
    const positive = total ? (scores.filter(s=>s>=4).length / total) * 100 : 0;
    return { total, avg, positive, scores };
  }
  function counts1to5(arr){
    const out = [0,0,0,0,0];
    arr.forEach(s => { if (s>=1 && s<=5) out[s-1]++; });
    return out;
  }
  function monthKey(s){
    const d = new Date(s);
    if (isNaN(d)) return null;
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
  }

  // -------- charts helpers --------
  function destroyCharts(){ charts.forEach(ch => { try{ch.destroy()}catch{} }); charts = []; }
  function pie(canvas, labels, data){
    const ctx = document.getElementById(canvas);
    const ch = new Chart(ctx, { type:'pie', data:{ labels, datasets:[{ data }] } });
    charts.push(ch);
  }
  function line(canvas, labels, data){
    const ctx = document.getElementById(canvas);
    const ch = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ data, tension:.25 }] },
      options:{ scales:{ y:{ min:0, max:100, ticks:{ callback:v=>v+'%' }}}}});
    charts.push(ch);
  }
  function bar(canvas, labels, data){
    const ctx = document.getElementById(canvas);
    const ch = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data }] },
      options:{ indexAxis:'y' }});
    charts.push(ch);
  }

  // -------- themes (very simple) --------
  const STOP = new Set(['the','a','an','of','and','to','in','for','on','at','with','is','are','be','it','that','this','we','i','you','our','your']);
  function extractThemes(rows, textCol){
    if (!textCol) return [];
    const bag = new Map();
    rows.forEach(r=>{
      const t = (r[textCol]||'').toString().toLowerCase();
      t.replace(/[^a-z0-9 ]+/g,' ').split(/\s+/).forEach(w=>{
        if (!w || STOP.has(w) || w.length<3) return;
        bag.set(w, (bag.get(w)||0)+1);
      });
    });
    return Array.from(bag.entries()).sort((a,b)=>b[1]-a[1]).slice(0,10);
  }

  // -------- render all --------
  function renderAll({ rows, cols, kpis, dataset }){
    // KPIs
    document.getElementById('kpiResponses').textContent = kpis.total;
    document.getElementById('kpiAvg').textContent = kpis.avg.toFixed(2);
    document.getElementById('kpiPos').textContent = Math.round(kpis.positive) + '%';

    // Distribution table + pies
    destroyCharts();
    const dist = counts1to5(kpis.scores);
    const tbody = document.getElementById('distTable');
    tbody.innerHTML = '';
    for (let i=1;i<=5;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="text-align:left">${i}</td><td>${dist[i-1]}</td>`;
      tbody.appendChild(tr);
    }
    pie('pieCurrent', ['1','2','3','4','5'], dist);

    // Combined pie (all datasets we have cached)
    const allScores = Object.values(ALL_CACHE).flatMap(rr=>{
      const c = detectColumns(rr, dataset);
      return rr.map(r=>toScore(r[c.scoreCol])).filter(x=>x!=null);
    });
    pie('pieAll', ['1','2','3','4','5'], counts1to5(allScores));

    // Trend %≥4 by month
    const m = {};
    rows.forEach(r=>{
      const mk = monthKey(r[cols.dateCol]);
      const sc = toScore(r[cols.scoreCol]);
      if(!mk || sc==null) return;
      m[mk] ||= {pos:0,total:0};
      m[mk].total++; if(sc>=4) m[mk].pos++;
    });
    const months = Object.keys(m).sort();
    const pct = months.map(k => m[k].total ? Math.round(100*m[k].pos/m[k].total) : 0);
    line('trendChart', months, pct);

    // Themes
    const themes = extractThemes(rows, cols.textCol);
    bar('themesChart', themes.map(x=>x[0]), themes.map(x=>x[1]));
  }

  // -------- main loaders --------
  async function loadDatasetsIndex(){
    const root = await fetchJSON('data/datasets.json');
    DATASETS = normalizeRoot(root);
    const sel = document.getElementById('datasetSel');
    sel.innerHTML = DATASETS.map(d => `<option value="${d.id}">${d.title}</option>`).join('');
    if (!CURRENT_ID || !DATASETS.some(d=>d.id===CURRENT_ID)) CURRENT_ID = DATASETS[0]?.id || null;
    sel.value = CURRENT_ID || '';
  }

  async function loadRowsFor(id){
    const ds = getDatasetById(id);
    if (!ds) return [];
    const text = await fetchText(ds.csv);
    return parseCSV(text);
  }

  async function loadAndRenderCurrent(){
    const ds = getDatasetById(CURRENT_ID);
    if (!ds) return;

    const rows = await loadRowsFor(ds.id);
    ALL_CACHE[ds.id] = rows; // store for combined pie
    const cols = detectColumns(rows, ds);
    const kpis = computeKPIs(rows, cols);
    renderAll({ rows, cols, kpis, dataset: ds });
  }

  // -------- events --------
  document.getElementById('datasetSel').addEventListener('change', (e)=>{
    CURRENT_ID = e.target.value;        // <-- critical
    loadAndRenderCurrent();             // refresh view for Q2, etc.
  });
  document.getElementById('reloadBtn').addEventListener('click', ()=>{
    loadAndRenderCurrent();             // cache-busted fetch
  });

  // Drag-drop upload mode (optional local preview)
  const drop = document.getElementById('dropZone');
  drop.addEventListener('dragover', e=>{e.preventDefault(); drop.classList.add('drag');});
  drop.addEventListener('dragleave', ()=>drop.classList.remove('drag'));
  drop.addEventListener('drop', async e=>{
    e.preventDefault(); drop.classList.remove('drag');
    const files = [...e.dataTransfer.files].filter(f=>/\.csv$/i.test(f.name));
    if (!files.length) return;
    // Treat each dropped CSV as its own dataset (id from filename)
    const readers = await Promise.all(files.map(f => f.text()));
    DATASETS = files.map((f,i)=>({ id: f.name.replace(/\.[^/.]+$/,''), title: f.name, csv: '(uploaded)', answerColumn:'', textColumn:'' }));
    const sel = document.getElementById('datasetSel');
    sel.innerHTML = DATASETS.map(d=>`<option value="${d.id}">${d.title}</option>`).join('');
    ALL_CACHE = {};
    // prime cache
    DATASETS.forEach((d,i)=>{
      ALL_CACHE[d.id] = parseCSV(readers[i]);
    });
    CURRENT_ID = DATASETS[0].id;
    sel.value = CURRENT_ID;
    // render first
    const rows = ALL_CACHE[CURRENT_ID];
    const cols = detectColumns(rows, DATASETS[0]);
    const kpis = computeKPIs(rows, cols);
    renderAll({ rows, cols, kpis, dataset: DATASETS[0] });
  });

  // -------- boot --------
  (async function init(){
    await loadDatasetsIndex();
    await loadAndRenderCurrent();
  })();
  </script>
</body>
</html>
