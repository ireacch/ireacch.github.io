<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Micro Survey Overview | I-REACCH</title>

  <link rel="stylesheet" href="assets/css/brand.css">
  <link rel="stylesheet" href="assets/css/header.css">
  <link rel="stylesheet" href="assets/css/style.css">

  <style>
    :root{
      --accent:#4a6cf7; --accent-2:#9b51e0; --bg-soft:#f5f8ff; --border:#e9eef6;
      --text:#1b2a41; --muted:#66788a; --pill-bg:#eef4ff; --pill-tx:#2f5d98;
      --done-bg:#e7f8ec; --done-tx:#1f7a41; --red-pill:#ff6b6b; --page-max:1200px;
    }

    .overview-bar{ background:#cfe4e7; padding:22px 0; border-bottom:1px solid #c3d6d9; }
    .overview-inner{ max-width:var(--page-max); margin:0 auto; padding:0 24px; display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .brand-wrap{ display:flex; align-items:center; gap:14px; }
    .brand-wrap img{ height:48px; width:auto; display:block; }
    .page-title{ font-size:22px; font-weight:800; color:var(--text); }
    .back-link{ font-weight:700; font-size:15px; color:#245b74; text-decoration:none; padding:8px 12px; border-radius:8px; }
    .back-link:hover{ background:rgba(0,0,0,.05); }

    .page{ max-width:var(--page-max); margin:18px auto 48px; padding:0 24px; }

    .intro-card{ background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:0 6px 18px rgba(28,39,51,.06); overflow:hidden; margin-bottom:20px; }
    .intro-grid{ display:grid; grid-template-columns:1fr 360px; gap:24px; padding:20px; }
    @media (min-width:1100px){ .intro-grid{ grid-template-columns:1fr 480px; } }
    @media (max-width:980px){ .intro-grid{ grid-template-columns:1fr; } }
    .intro-card h2{ margin:0 0 8px; font-size:16px; color:var(--text); }
    .intro-card p{ margin:.35rem 0; color:var(--text); }
    .intro-figure{ display:flex; align-items:center; justify-content:center; }
    .intro-figure img{ max-width:460px; width:100%; height:auto; border-radius:10px; border:1px solid var(--border); box-shadow:0 6px 16px rgba(28,39,51,.08); }

    .runner{ display:grid; grid-template-columns:320px 1fr; gap:20px; }
    @media (max-width:980px){ .runner{ grid-template-columns:1fr; } }

    .panel{ background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:0 6px 18px rgba(28,39,51,.06); overflow:hidden; }
    .panel .hd{ padding:14px 16px; border-bottom:1px solid var(--border); }
    .panel .bd{ padding:14px 16px; }

    .side-title{ margin:0 0 10px; font-size:17px; font-weight:800; color:var(--text); }
    .filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:0; }
    .filters a{ display:inline-block; padding:4px 8px; border-radius:6px; font-weight:700; font-size:14px; line-height:1; text-decoration:none; color:var(--muted); background:transparent; border:1px solid transparent; transition:background .15s,border-color .15s,color .15s; }
    .filters a:hover{ background:#f7faff; }
    .filters a.active{ color:var(--accent); background:var(--bg-soft); border-color:var(--border); }
    .filters .sep{ color:#c6cbd6; }

    .list{ display:flex; flex-direction:column; gap:12px; }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; cursor:pointer; }
    .item:hover{ background:var(--bg-soft); }
    .item.active{ box-shadow:0 0 0 3px var(--accent); border-color:transparent; background:#fff; }

    .title{ font-weight:700; color:var(--text); font-size:16px; line-height:1.28; }
    .meta{ font-size:13px; color:var(--muted); margin-top:4px; }
    .left{ display:flex; flex-direction:column; }
    .right{ display:flex; align-items:center; gap:8px; }

    .pill{ font-size:11px; font-weight:700; padding:4px 10px; border-radius:999px; background:var(--pill-bg); color:var(--pill-tx); border:1px solid var(--border); }
    .pill.done{ background:var(--done-bg); color:var(--done-tx); }
    .pill.unfinished{ background:var(--red-pill); color:#fff; border-color:var(--red-pill); }

    .head-row{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .h2{ margin:0; color:var(--text); font-size:18px; font-weight:800; }
    .muted{ color:var(--muted); font-size:12px; }

    .frame-wrap{ position:relative; }
    iframe{ width:100%; height:600px; border:0; border-radius:12px; background:#fff; display:block; }

    /* Fallback overlay */
    .fallback{
      position:absolute; inset:0;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      gap:10px; text-align:center;
      padding:16px;
      border-radius:12px;
      background:rgba(255,255,255,0.92);
      border:1px dashed var(--border);
    }
    .fallback .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .btn{ appearance:none; border:0; border-radius:999px; padding:10px 16px; font-weight:800; color:#fff; background:linear-gradient(135deg,var(--accent-2),var(--accent)); cursor:pointer; }
    .btn.ghost{ background:#fff; color:#1b2a41; border:1px solid var(--border); }
    .btn.link{ background:transparent; color:#1b2a41; border:0; text-decoration:underline; padding:0; }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center; }
    .complete-note{ color:var(--red-pill); font-size:13px; font-weight:700; line-height:1.2; }
    .note{ font-size:12px; color:#b45309; }
  </style>
</head>
<body>

  <header class="overview-bar" role="banner">
    <div class="overview-inner">
      <div class="brand-wrap">
        <img src="assets/img/ireacch-logo.png" alt="I-REACCH">
        <div class="page-title">Micro Survey Overview</div>
      </div>
      <a class="back-link" href="https://ireacch.le.ac.uk/" target="_blank" rel="noopener">Back to official website</a>
    </div>
  </header>

  <main class="page">
    <section class="intro-card" aria-labelledby="intro-heading">
      <div class="intro-grid">
        <div>
          <h2 id="intro-heading">Speak up for research culture: I-REACCH Micro Survey</h2>
          <p>The Wellcome-funded I-REACCH project is piloting interventions to support a more inclusive and supportive research culture at the University of Leicester.</p>
          <h2>Why take part?</h2>
          <p>Each weekly micro-survey has one question and takes &lt; 1 minute. It’s anonymous and open to research staff, enabling staff, and PGRs.</p>
          <h2>Privacy</h2>
          <p>You may be asked to sign in with your University account to access the form; your identity isn’t collected by I-REACCH.</p>
        </div>
        <figure class="intro-figure" aria-hidden="true">
          <img src="assets/img/speak-up.png" alt="">
        </figure>
      </div>
    </section>

    <div class="runner">
      <aside class="panel" aria-labelledby="list-heading">
        <div class="hd">
          <h3 id="list-heading" class="side-title">Survey List</h3>
          <nav class="filters" id="filters" aria-label="Filter surveys">
            <a href="#" data-filter="all" class="active">All</a><span class="sep">|</span>
            <a href="#" data-filter="unfinished">Unfinished</a><span class="sep">|</span>
            <a href="#" data-filter="completed">Completed</a>
          </nav>
        </div>
        <div class="bd"><div id="list" class="list"></div></div>
      </aside>

      <section class="panel" aria-live="polite">
        <div class="hd">
          <div class="head-row">
            <div>
              <h2 class="h2" id="currTitle">Select a micro survey</h2>
              <div class="muted" id="currDate"></div>
            </div>
            <div class="status"><span id="currBadge" class="pill unfinished">Unfinished</span></div>
          </div>
        </div>

        <div class="bd">
          <div class="frame-wrap">
            <iframe id="formFrame" title="Survey"></iframe>

            <!-- Fallback overlay -->
            <div id="formFallback" class="fallback" aria-live="polite">
              <div><b>We can’t show the survey here.</b></div>
              <div class="actions">
                <a id="openNewTab" class="btn ghost" target="_blank" rel="noopener">Open in a new tab</a>
                <button id="btnSignin" class="btn ghost" type="button">Sign in to Microsoft</button>
                <button id="btnRefresh" class="btn link" type="button">Refresh</button>
              </div>
              <div class="muted" style="margin-top:6px">
                Tip: click <b>Sign in to Microsoft</b>, finish the popup, then use <b>Open in a new tab</b> or <b>Refresh</b>.
              </div>
              <div id="popupNote" class="note" style="display:none;">Your browser blocked the automatic sign-in popup — please click “Sign in to Microsoft”.</div>
            </div>
          </div>

          <div class="controls">
            <button id="btnComplete" class="btn">Mark as completed</button>
            <span class="complete-note">Please press “Submit” in the survey before marking it as completed.</span>
          </div>
        </div>
      </section>
    </div>

    <!-- Admin helper (optional) -->
    <section id="admin" class="admin" style="display:none">
      <h2 style="margin:0 0 8px">Admin • add a survey (JSON helper)</h2>
      <div class="grid">
        <input id="aTitle" placeholder="Title e.g., I-REACCH Micro Survey (Q1) Feel Valued"/>
        <input id="aMinutes" placeholder="Minutes (e.g., 1)"/>
      </div>
      <div class="grid">
        <input id="aAudience" placeholder="Audience (e.g., Staff/PGR)"/>
        <input id="aSchool" placeholder="School/College (optional)"/>
      </div>
      <input id="aUrl" placeholder="Microsoft Forms URL"/>
      <div class="controls">
        <button id="aAdd" class="btn">Add to config (in memory)</button>
        <button id="aExport" class="btn" style="background:var(--bg-soft);color:var(--text)">Export JSON</button>
      </div>
      <code id="aOut" class="json-out" style="display:none"></code>
    </section>
  </main>

  <script>
    /* ------------ Load surveys + LIVE submission dates ------------ */
    let SURVEYS = [];
    const LIVE = { updatedAt: null, surveys: {} };

    async function loadSurveys(){
      try{
        const r = await fetch('surveys.json?cb=' + Date.now());
        SURVEYS = await r.json();
      }catch{ SURVEYS = []; }
    }
    async function loadLive(){
      try{
        const r = await fetch('data/submissions.json?cb=' + Date.now());
        const j = await r.json();
        LIVE.updatedAt = j.updatedAt || null;
        LIVE.surveys   = j.surveys   || {};
      }catch{}
    }

    /* ------------ Local completion status ------------ */
    const statusKey = id => `survey-status:${id}`;
    const whenKey   = id => `survey-completed-at:${id}`;
    const getStatus = id => localStorage.getItem(statusKey(id)) || "not";
    function setStatus(id, s){
      localStorage.setItem(statusKey(id), s);
      if(s === 'done') localStorage.setItem(whenKey(id), new Date().toISOString());
      renderList(current?.id);
      updateBtn();
    }

    /* ------------ UI refs ------------ */
    const $list   = document.getElementById('list');
    const $frame  = document.getElementById('formFrame');
    const $fallback = document.getElementById('formFallback');
    const $openNewTab = document.getElementById('openNewTab');
    const $btnSignin  = document.getElementById('btnSignin');
    const $btnRefresh = document.getElementById('btnRefresh');
    const $popupNote  = document.getElementById('popupNote');

    const $title  = document.getElementById('currTitle');
    const $date   = document.getElementById('currDate');
    const $badge  = document.getElementById('currBadge');
    const $btn    = document.getElementById('btnComplete');
    const $filters= document.getElementById('filters');

    let current = null, filter = "all";

    /* Filters */
    [...$filters.querySelectorAll('a')].forEach(a=>{
      a.onclick = e => {
        e.preventDefault();
        [...$filters.querySelectorAll('a')].forEach(x=>x.classList.remove('active'));
        a.classList.add('active');
        filter = a.dataset.filter;
        renderList(current?.id);
      };
    });

    /* Dates + labels */
    const fmt = (any) => {
      if (!any) return '';
      const d = new Date(any);
      if (!isNaN(d)) {
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yy = d.getFullYear();
        return `${dd}.${mm}.${yy}`;
      }
      return String(any);
    };
    function getDisplayDate(id, surveyObj){
      const live = LIVE.surveys?.[id] || {};
      const pick = live.publishedAt || live.lastSubmittedAt || surveyObj?.publishedAt || surveyObj?.date || null;
      return fmt(pick);
    }
    function labelForList(s, index){
      return s.displayTitle && s.displayTitle.trim().length
        ? s.displayTitle
        : `Q${index+1}: ${s.title}`;
    }
    function labelForPanel(s){
      const idx = SURVEYS.findIndex(x=>x.id===s.id);
      return s.displayTitle && s.displayTitle.trim().length
        ? s.displayTitle
        : `Q${idx+1}: ${s.title}`;
    }

    /* Render list */
    function renderList(activeId){
      $list.innerHTML = '';
      SURVEYS.forEach((s, i) => {
        const isDone = (getStatus(s.id) === 'done');
        if(filter === 'unfinished' && isDone) return;
        if(filter === 'completed' && !isDone) return;

        const item = document.createElement('div');
        item.className = 'item' + (s.id === activeId ? ' active' : '');
        item.dataset.id = s.id;

        const pillClass = isDone ? 'pill done' : 'pill unfinished';
        const pillText  = isDone ? 'Completed' : 'Unfinished';
        const titleForList = labelForList(s, i);
        const dateText = getDisplayDate(s.id, s);

        item.innerHTML = `
          <div class="left">
            <div class="title">${titleForList}</div>
            <div class="meta">Published: ${dateText || '—'}</div>
          </div>
          <div class="right"><span class="${pillClass}">${pillText}</span></div>`;
        item.onclick = () => loadSurvey(s.id);
        $list.appendChild(item);
      });
    }

    /* ---- Auto sign-in attempt (may be blocked by popup blockers) ---- */
    function tryAutoSignin(){
      const LOGIN_URL = 'https://login.microsoftonline.com/';
      const w = 640, h = 720;
      const left = (screen.width - w) / 2;
      const top  = (screen.height - h) / 2;
      const win = window.open(LOGIN_URL, 'mslogin',
        `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`);
      if (!win) {
        // blocked
        $popupNote.style.display = 'block';
        return;
      }
      // Close the popup automatically after a short while (if allowed).
      setTimeout(() => { try { win.close(); } catch(_){} }, 4000);
    }

    /* Load a survey: set up frame, overlay, auto sign-in attempt */
    function loadSurvey(id){
      const s = SURVEYS.find(x => x.id === id); if(!s) return;
      current = s;

      $title.textContent = labelForPanel(s);
      const dateText = getDisplayDate(s.id, s);
      $date.textContent = dateText ? `Published: ${dateText}` : '';

      const isDone = (getStatus(id) === 'done');
      $badge.textContent = isDone ? 'Completed' : 'Unfinished';
      $badge.className   = isDone ? 'pill done' : 'pill unfinished';

      $popupNote.style.display = 'none';

      // Always keep overlay visible (tenant may block iframe).
      $openNewTab.href = s.url;

      // Load the iframe behind the overlay (for tenants that do allow it).
      const sep = s.url.includes('?') ? '&' : '?';
      $frame.src = s.url + sep + 'cb=' + Date.now();
      document.getElementById('formFallback').style.display = 'flex';

      // Attempt auto sign-in (may be blocked by browser).
      tryAutoSignin();

      renderList(id);
      updateBtn();
    }

    /* Manual sign-in button */
    document.getElementById('btnSignin').addEventListener('click', () => {
      $popupNote.style.display = 'none';
      tryAutoSignin();
    });

    /* Refresh button re-loads the iframe src (useful after sign-in) */
    document.getElementById('btnRefresh').addEventListener('click', () => {
      if (!current) return;
      const sep = current.url.includes('?') ? '&' : '?';
      $frame.src = current.url + sep + 'cb=' + Date.now();
      // Keep the overlay; if tenant allows embedding, you can manually hide overlay in code here,
      // but most universities block iframes for Forms, so open-in-new-tab remains the reliable path.
    });

    function updateBtn(){
      if(!current){ $btn.disabled = true; return; }
      const done = getStatus(current.id) === 'done';
      $btn.textContent = done ? 'Completed' : 'Mark as completed';
      $btn.disabled = done;
    }

    document.getElementById('btnComplete').onclick = () => {
      if(!current) return;
      setStatus(current.id,'done');
      loadSurvey(current.id);
    };

    /* Admin helper (?admin=1) */
    const urlParams = new URLSearchParams(location.search);
    if(urlParams.get("admin")==="1"){
      const admin = document.getElementById('admin');
      admin.style.display='block';
      document.getElementById('aAdd').onclick=()=>{
        const title=document.getElementById('aTitle').value.trim();
        const minutes=parseInt(document.getElementById('aMinutes').value.trim()||"1",10);
        const audience=document.getElementById('aAudience').value.trim();
        const school=document.getElementById('aSchool').value.trim();
        const url=document.getElementById('aUrl').value.trim();
        if(!title||!url){alert("Title and URL are required");return;}
        SURVEYS.push({id:slugify(title),title,minutes,audience,school:school||"All",url});
        renderList(current?.id);
        ['aTitle','aMinutes','aAudience','aSchool','aUrl'].forEach(id=>document.getElementById(id).value="");
      };
      document.getElementById('aExport').onclick=()=>{
        const out=document.getElementById('aOut');
        out.textContent=JSON.stringify(SURVEYS,null,2);
        out.style.display="block";
        window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
      };
    }
    function slugify(s){
      return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,60);
    }

    /* Boot */
    (async()=>{
      await Promise.all([loadSurveys(), loadLive()]);
      renderList();
      if(SURVEYS[0]) loadSurvey(SURVEYS[0].id);
    })();
  </script>
</body>
</html>
