<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>I-REACCH | Best Practices</title>

  <link rel="stylesheet" href="assets/css/brand.css" />
  <link rel="stylesheet" href="assets/css/header.css" />
  <link rel="stylesheet" href="assets/css/style.css" />

  <style>
    :root{
      --border:#e6ecf1; --muted:#556070; --muted-strong:#384454;
      --chip:#eef2f7; --blue:#6366f1; --bg:#fff;
      --ok:#2ea44f; --warn:#e3a008; --no:#cf3d3d;
      --page-max:1200px;
    }

    /* ===== Consistent top header (matched to micro-surveys & reflection) ===== */
    .overview-bar{ background:#cfe4e7; padding:22px 0; border-bottom:1px solid #c3d6d9; }
    .overview-inner{ max-width:var(--page-max); margin:0 auto; padding:0 24px; display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .brand-wrap{ display:flex; align-items:center; gap:14px; }
    .brand-wrap img{ height:48px; width:auto; display:block; }
    .titles{ display:flex; flex-direction:column; }
    .page-title{ font-size:22px; font-weight:800; color:#1b2a41; }
    .page-sub{ margin-top:2px; font-size:14px; color:var(--muted); }
    .back-link{ font-weight:700; font-size:15px; color:#245b74; text-decoration:none; padding:8px 12px; border-radius:8px; }
    .back-link:hover{ background:rgba(0,0,0,.05); }

    /* page container (kept) */
    .bp-container{max-width:1200px;margin:32px auto;padding:0 24px}
    @media (max-width:640px){.bp-container{padding:0 16px}}

    /* grid (kept) */
    .bp-grid{display:grid;grid-template-columns:380px 1fr;gap:24px}
    @media (max-width:1000px){.bp-grid{grid-template-columns:1fr;gap:28px}}

    /* panels now also pick up brand .card / .pad */
    .bp-panel{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(28,39,51,.04)}
    .bp-pad{padding:20px}

    /* form controls now also use brand classes */
    .bp-panel h3{margin:0 0 10px;font-size:1.1rem}
    .bp-panel label{display:block;font-weight:600;margin:14px 0 6px}
    .bp-input,.bp-select,.bp-textarea{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;
      font:inherit;background:var(--bg)
    }
    .bp-input:focus,.bp-select:focus,.bp-textarea:focus,.bp-btn:focus,.bp-chip:focus,.bp-tag-btn:focus,.bp-vote button:focus{
      outline:2px solid var(--blue);outline-offset:2px
    }
    .bp-textarea{min-height:120px;resize:vertical}

    /* buttons now also use brand styles */
    .bp-row{display:flex;gap:10px;align-items:center}
    .bp-btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer;background:linear-gradient(90deg,#4a1ea8,#0aa0ff);color:#fff}
    .bp-btn.ghost{background:transparent;border:1px solid var(--border);color:#1c2733}
    .bp-btn[type="button"]{ }

    /* browse toolbar */
    .bp-toolbar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px;align-items:center}
    .bp-field{flex:1 1 260px}
    .bp-cnt{color:var(--muted);font-size:.88rem}
    .bp-sort{min-width:180px}

    /* active filters */
    .bp-filter-pills{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
    .bp-pill{background:var(--chip);color:var(--muted-strong);border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-weight:600;font-size:.85rem}
    .bp-pill button{border:0;background:transparent;margin-left:6px;cursor:pointer}

    /* cards grid */
    .bp-cards{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:1100px){.bp-cards{grid-template-columns:1fr}}

    /* card */
    .bp-card{border:1px solid var(--border);border-radius:16px;background:#fff;padding:18px;display:flex;flex-direction:column;gap:10px}
    .bp-card h4{margin:0;font-size:1.05rem}
    .bp-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eaf5ff;color:#0c5ea8;font-weight:600;font-size:.86rem}
    .bp-sub{color:var(--muted);margin:0}

    /* tags */
    .bp-tags{display:flex;gap:8px;row-gap:6px;flex-wrap:wrap}
    .bp-chip{background:var(--chip);color:var(--muted-strong);padding:4px 10px;border:1px solid var(--border);border-radius:999px;font-weight:600;font-size:.82rem}
    .bp-tag-btn{background:var(--chip);color:var(--muted-strong);border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-weight:600;font-size:.82rem;cursor:pointer}
    .bp-sep{height:1px;background:var(--border);border-radius:1px;margin:2px 0}

    /* vote buttons */
    .bp-cta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .bp-vote{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .bp-vote button{border:1px solid var(--border);background:#fff;color:#1c2733;border-radius:999px;padding:8px 10px;font-weight:700;cursor:pointer}
    .bp-vote button.adopt{border-color:color-mix(in srgb, var(--ok) 50%, #fff)}
    .bp-vote button.consider{border-color:color-mix(in srgb, var(--warn) 60%, #fff)}
    .bp-vote button.notfor{border-color:color-mix(in srgb, var(--no) 55%, #fff)}
    .bp-vote button.active.adopt{background:var(--ok);color:#fff}
    .bp-vote button.active.consider{background:var(--warn);color:#fff}
    .bp-vote button.active.notfor{background:var(--no);color:#fff}
    .bp-vote button.didnt{border-color:#9aa4b2}
    .bp-vote button.active.didnt{background:#9aa4b2;color:#fff}
    .bp-count{font-size:.86rem;color:var(--muted)}

    .bp-empty{padding:18px;color:var(--muted);border:1px dashed var(--border);border-radius:12px;background:#fff}
    .bp-hint{font-size:.9rem;color:var(--muted)}
    .bp-help{font-size:.85rem;color:var(--muted);margin-top:4px}

    .counter{display:flex;justify-content:space-between;font-size:.8rem;color:var(--muted);margin-top:4px}
    .suggested-tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .suggested-tags .bp-chip{cursor:pointer}
  </style>
</head>
<body>

  <!-- Consistent I-REACCH header -->
  <header class="overview-bar" role="banner">
    <div class="overview-inner">
      <div class="brand-wrap">
        <img src="assets/img/ireacch-logo.png" alt="I-REACCH">
        <div class="titles">
          <div class="page-title">Best Practices for Enhancing Research Culture & Knowledge Exchange</div>
          <div class="page-sub">Share what works; see what peers are adopting across Schools and Colleges.</div>
        </div>
      </div>
      <a class="back-link" href="https://ireacch.le.ac.uk/" target="_blank" rel="noopener">Back to official website</a>
    </div>
  </header>

  <!-- Page -->
  <main class="bp-container">
    <section class="bp-grid">
      <!-- Submit -->
      <aside class="bp-panel card">
        <div class="bp-pad pad">
          <h3>Submit a practice that enhances research culture</h3>

          <label for="bp-title">Title</label>
          <input id="bp-title" class="bp-input input" type="text" maxlength="80" placeholder="e.g., Mentoring circles for new PGRs" />
          <div class="counter"><span>Keep it specific</span><span id="c-title">0/80</span></div>

          <label for="bp-school">School / College (open text)</label>
          <input id="bp-school" class="bp-input input" type="text" placeholder="e.g., School of Business / Doctoral College" />

          <label for="bp-desc">Description</label>
          <textarea id="bp-desc" class="bp-textarea textarea" maxlength="800" placeholder="How does it work? Who benefits? Any tips to adopt? Mention any resources/time needed."></textarea>
          <div class="counter"><span>What would help someone replicate this?</span><span id="c-desc">0/800</span></div>

          <label for="bp-tags">Tags (optional, comma-separated)</label>
          <input id="bp-tags" class="bp-input input" type="text" placeholder="mentoring, onboarding, community" />
          <div class="suggested-tags" id="suggested-tags">
            <span class="bp-chip chip" data-tag="mentoring">mentoring</span>
            <span class="bp-chip chip" data-tag="onboarding">onboarding</span>
            <span class="bp-chip chip" data-tag="community">community</span>
            <span class="bp-chip chip" data-tag="transparency">transparency</span>
            <span class="bp-chip chip" data-tag="workload">workload</span>
            <span class="bp-chip chip" data-tag="training">training</span>
          </div>

          <div class="bp-row" style="margin-top:12px">
            <button class="bp-btn btn primary" id="bp-add" type="button">Add practice</button>
            <button class="bp-btn btn ghost" id="bp-clear" type="button">Clear</button>
            <span id="draft-status" class="bp-hint" style="margin-left:8px;display:none">Draft saved</span>
          </div>
          <p class="bp-hint" style="margin-top:10px">
            Please avoid personal data. Submissions are lightly moderated before publishing.
          </p>
        </div>
      </aside>

      <!-- Browse -->
      <section class="bp-panel card">
        <div class="bp-pad pad">
          <h3>Browse practices</h3>

          <div class="bp-toolbar">
            <div class="bp-field">
              <input id="q" class="bp-input input" type="text" placeholder="Search title, description, or tags…" />
            </div>
            <div class="bp-field">
              <input id="filter-school" class="bp-input input" type="text" placeholder="Filter by School / College (free text)" />
            </div>
            <select id="sort" class="bp-select select bp-sort" aria-label="Sort results">
              <option value="adopted">Sort: Most adopted</option>
              <option value="newest">Sort: Newest</option>
              <option value="az">Sort: A–Z</option>
            </select>
            <span id="result-count" class="bp-cnt" aria-live="polite">0 results</span>
          </div>

          <div id="active-pills" class="bp-filter-pills" style="display:none"></div>

          <div id="cards" class="bp-cards"></div>
          <div id="empty" class="bp-empty" style="display:none">
            No practices match those filters. <button id="clear-filters" type="button" class="bp-btn btn ghost" style="margin:8px 0">Clear filters</button>
            or <a href="#bp-title">add this as a new practice</a>.
          </div>
        </div>
      </section>
    </section>
  </main>

  <script>
    /* ---------- Seed data ---------- */
    const seedData = [
      { id:"p1", title:"Transparent workload board",
        school:"College of Social Sciences, Arts & Humanities",
        desc:"Team-visible board mapping roles and time allocations; updated monthly.",
        tags:["transparency","workload"],
        votes:{ adopted:4, considering:1, notfor:0, didnt:0 },
        created: Date.now()-86400000*14 },
      { id:"p2", title:"Mentoring circles for new PGRs",
        school:"Doctoral College / PGR",
        desc:"Monthly peer circles with a rotating facilitator to share challenges and signpost support.",
        tags:["mentoring","onboarding","community"],
        votes:{ adopted:0, considering:0, notfor:0, didnt:0 },
        created: Date.now()-86400000*3 }
    ];

    /* ---------- State & storage ---------- */
    const LS_VOTE_CHOICE = id => `bp-vote-${id}`;          // per-user choice
    const LS_TALLIES     = 'bp-tallies';                   // totals map
    const LS_REASON      = id => `bp-reason-${id}`;        // reason text
    const LS_DRAFT       = 'bp-draft';                     // form draft

    const getTallies = () => JSON.parse(localStorage.getItem(LS_TALLIES) || '{}');
    const setTallies = obj => localStorage.setItem(LS_TALLIES, JSON.stringify(obj));

    // Merge tallies from LS into seeds
    function hydrate(data){
      const tallies = getTallies();
      return data.map(p=>{
        const t = tallies[p.id];
        return t ? {...p, votes: {...p.votes, ...t}} : p;
      });
    }

    let state = {
      data: hydrate(seedData),
      query: "", school: "", sort: "adopted", tags: new Set()
    };

    /* ---------- DOM ---------- */
    const cardsEl = document.getElementById("cards");
    const emptyEl = document.getElementById("empty");
    const qEl = document.getElementById("q");
    const filterSchoolEl = document.getElementById("filter-school");
    const sortEl = document.getElementById("sort");
    const countEl = document.getElementById("result-count");
    const pillsEl = document.getElementById("active-pills");

    const titleEl = document.getElementById("bp-title");
    const schoolEl = document.getElementById("bp-school");
    const descEl = document.getElementById("bp-desc");
    const tagsEl = document.getElementById("bp-tags");
    const addBtn = document.getElementById("bp-add");
    const clearBtn = document.getElementById("bp-clear");
    const draftStatus = document.getElementById("draft-status");
    const cTitle = document.getElementById("c-title");
    const cDesc = document.getElementById("c-desc");

    /* ---------- Helpers ---------- */
    const uid = () => "p" + Math.random().toString(36).slice(2,9);
    const norm = s => (s||"").toLowerCase();
    const escapeHtml = s => (s||"").replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    function filtered(){
      const q = norm(state.query), s = norm(state.school);
      let items = state.data.filter(p=>{
        const text = `${p.title} ${p.desc} ${p.school} ${(p.tags||[]).join(" ")}`.toLowerCase();
        const tagOk = state.tags.size ? (p.tags||[]).some(t=>state.tags.has(norm(t))) : true;
        return (!q || text.includes(q)) && (!s || norm(p.school).includes(s)) && tagOk;
      });

      // sort
      if(state.sort === 'adopted'){
        items.sort((a,b)=> (b.votes.adopted||0) - (a.votes.adopted||0));
      }else if(state.sort === 'newest'){
        items.sort((a,b)=> (b.created||0) - (a.created||0));
      }else{ // az
        items.sort((a,b)=> a.title.localeCompare(b.title));
      }
      return items;
    }

    function updateResultCount(n){
      countEl.textContent = `${n} ${n===1?'result':'results'}`;
    }

    function renderPills(){
      const pills = [];
      if(state.query) pills.push({label:`Search: "${state.query}"`, clear:()=>{state.query=""; qEl.value="";}});
      if(state.school) pills.push({label:`School: ${state.school}`, clear:()=>{state.school=""; filterSchoolEl.value="";}});
      [...state.tags].forEach(tag => pills.push({label:`Tag: ${tag}`, clear:()=>{state.tags.delete(tag);}}));

      pillsEl.innerHTML = '';
      if(!pills.length){ pillsEl.style.display='none'; return; }
      pillsEl.style.display='flex';
      pills.forEach(p=>{
        const el = document.createElement('span');
        el.className='bp-pill';
        el.innerHTML = `${escapeHtml(p.label)} <button type="button" aria-label="Remove filter">✕</button>`;
        el.querySelector('button').onclick = ()=>{ p.clear(); render(); };
        pillsEl.appendChild(el);
      });
    }

    function render(){
      const items = filtered();
      cardsEl.innerHTML = "";
      emptyEl.style.display = items.length ? "none" : "block";
      updateResultCount(items.length);
      renderPills();

      items.forEach(p=>{
        const userVote = localStorage.getItem(LS_VOTE_CHOICE(p.id)) || "";

        const card = document.createElement("div");
        card.className = "bp-card";
        card.id = p.id;

        // header + submitter
        const submitter = `<a href="#${p.id}" class="bp-badge" title="Submitted by">${escapeHtml(p.school)}</a>`;

        card.innerHTML = `
          <h4>${escapeHtml(p.title)}</h4>
          <div class="bp-row" style="gap:8px">${submitter}</div>
          <div class="bp-sub">${escapeHtml(p.desc)}</div>
          ${(p.tags?.length ? `<div class="bp-tags">`+
            p.tags.map(t=>`<button type="button" class="bp-tag-btn" data-tag="${escapeHtml(t)}">${escapeHtml(t)}</button>`).join("")+
          `</div>` : "")}
          <div class="bp-sep"></div>
        `;

        // vote line
        const line = document.createElement("div");
        line.className = "bp-cta";

        const vote = document.createElement("div");
        vote.className = "bp-vote";

        const btn = (label, cls, key) => {
          const b = document.createElement("button");
          b.type = "button";
          b.textContent = label;
          b.className = `${cls} ${userVote===key ? 'active '+cls : ''}`;
          b.setAttribute('aria-pressed', userVote===key ? 'true' : 'false');
          b.onclick = ()=>onVote(p, key);
          return b;
        };

        const btnAd = btn("Adopted","adopt","adopted");
        const btnCo = btn("Considering","consider","considering");
        const btnNo = btn("Not for us","notfor","notfor");
        const btnDi = btn("Didn't use it","didnt","didnt");

        const count = document.createElement("span");
        count.className = "bp-count";
        count.textContent = `· ${p.votes.adopted||0} adopted · ${p.votes.considering||0} considering · ${p.votes.notfor||0} not for us · ${p.votes.didnt||0} didn't use`;

        vote.append(btnAd, btnCo, btnNo, btnDi, count);
        line.appendChild(vote);
        card.appendChild(line);

        // reason for didn't use it (only when selected)
        const userChoseDidnt = userVote === 'didnt';
        const reasonWrap = document.createElement('div');
        reasonWrap.style.marginTop = '8px';
        reasonWrap.style.display = userChoseDidnt ? 'block' : 'none';
        reasonWrap.innerHTML = `
          <label class="bp-hint" for="r-${p.id}">Why didn't you use it? <i>(optional)</i></label>
          <textarea id="r-${p.id}" class="bp-textarea textarea" placeholder="e.g., Timing, not relevant to our context, missing resources…"></textarea>
          <div class="bp-help">Specifics help others understand context.</div>
        `;
        const reasonEl = reasonWrap.querySelector('textarea');
        reasonEl.value = localStorage.getItem(LS_REASON(p.id)) || '';
        reasonEl.addEventListener('input', ()=> localStorage.setItem(LS_REASON(p.id), reasonEl.value));
        card.appendChild(reasonWrap);

        // tag click-to-filter
        card.querySelectorAll('.bp-tag-btn').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const t = norm(btn.dataset.tag);
            state.tags.add(t);
            render();
            // scroll to top for clarity on mobile
            window.scrollTo({top:document.querySelector('.bp-panel .bp-pad').offsetTop-20, behavior:'smooth'});
          });
        });

        // show/hide reason when user toggles "didn't"
        function onVote(pObj, choice){
          const prev = localStorage.getItem(LS_VOTE_CHOICE(pObj.id));
          if(prev === choice) return; // no churn if same

          // update visible active states
          [btnAd,btnCo,btnNo,btnDi].forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
          const map = {adopted:btnAd, considering:btnCo, notfor:btnNo, didnt:btnDi};
          map[choice].classList.add('active'); map[choice].setAttribute('aria-pressed','true');

          // adjust tallies and persist
          const tallies = getTallies();
          const t = tallies[pObj.id] || {...pObj.votes};
          if(prev && t[prev]!=null) t[prev] = Math.max(0, t[prev]-1);
          t[choice] = (t[choice]||0)+1;
          tallies[pObj.id] = t;
          setTallies(tallies);

          // persist user choice
          localStorage.setItem(LS_VOTE_CHOICE(pObj.id), choice);

          // update card count text
          pObj.votes = t;
          count.textContent = `· ${t.adopted||0} adopted · ${t.considering||0} considering · ${t.notfor||0} not for us · ${t.didnt||0} didn't use`;

          // reason box toggle
          reasonWrap.style.display = choice==='didnt' ? 'block' : 'none';

          // re-sort if needed and re-render list (cheap—small list)
          state.data = hydrate(state.data);
          render();
        }

        cardsEl.appendChild(card);
      });
    }

    /* ---------- Events ---------- */
    qEl.addEventListener("input", e=>{state.query=e.target.value;render();});
    filterSchoolEl.addEventListener("input", e=>{state.school=e.target.value;render();});
    sortEl.addEventListener("change", e=>{state.sort=e.target.value;render();});
    document.getElementById('clear-filters').addEventListener('click', ()=>{
      state.query=""; qEl.value="";
      state.school=""; filterSchoolEl.value="";
      state.tags.clear();
      render();
    });

    // Character counters + draft autosave
    function updateCounters(){
      cTitle.textContent = `${titleEl.value.length}/80`;
      cDesc.textContent  = `${descEl.value.length}/800`;
    }
    [titleEl,descEl].forEach(el=>el.addEventListener('input', updateCounters));
    updateCounters();

    function saveDraft(){
      const draft = {title:titleEl.value, school:schoolEl.value, desc:descEl.value, tags:tagsEl.value};
      localStorage.setItem(LS_DRAFT, JSON.stringify(draft));
      draftStatus.style.display='inline';
      clearTimeout(saveDraft._t);
      saveDraft._t = setTimeout(()=>draftStatus.style.display='none', 1200);
    }
    [titleEl,schoolEl,descEl,tagsEl].forEach(el=>el.addEventListener('input', saveDraft));
    // load draft
    (()=>{ try{
      const d = JSON.parse(localStorage.getItem(LS_DRAFT)||'null');
      if(d){ titleEl.value=d.title||""; schoolEl.value=d.school||""; descEl.value=d.desc||""; tagsEl.value=d.tags||""; updateCounters(); }
    }catch{} })();

    // Suggested tag chips -> append to field
    document.getElementById('suggested-tags').addEventListener('click', e=>{
      const t = e.target?.dataset?.tag;
      if(!t) return;
      const parts = tagsEl.value.split(',').map(x=>x.trim()).filter(Boolean);
      if(!parts.map(norm).includes(norm(t))) parts.push(t);
      tagsEl.value = parts.join(', ');
      saveDraft();
    });

    // Add practice
    addBtn.addEventListener("click", ()=>{
      const title = titleEl.value.trim(), school = schoolEl.value.trim(), desc = descEl.value.trim();
      if(!title || !school || !desc){ alert("Please fill Title, School/College, and Description."); return; }
      const tags = tagsEl.value.split(",").map(t=>t.trim()).filter(Boolean);

      const item = { id:uid(), title, school, desc, tags, votes:{adopted:0,considering:0,notfor:0,didnt:0}, created: Date.now() };
      state.data.unshift(item);
      // clear form + draft
      titleEl.value = ""; schoolEl.value = ""; descEl.value = ""; tagsEl.value = ""; updateCounters();
      localStorage.removeItem(LS_DRAFT);
      draftStatus.style.display='none';

      render();
      // jump to the new card
      requestAnimationFrame(()=> document.getElementById(item.id)?.scrollIntoView({behavior:'smooth', block:'start'}));
    });

    clearBtn.addEventListener("click", ()=>{
      titleEl.value=schoolEl.value=descEl.value=tagsEl.value="";
      localStorage.removeItem(LS_DRAFT);
      updateCounters();
      titleEl.focus();
    });

    /* ---------- Boot ---------- */
    render();
  </script>
</body>
</html>
