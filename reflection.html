<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>I-REACCH | Reflection space</title>

  <!-- Shared brand styles -->
  <link rel="stylesheet" href="assets/css/brand.css"/>

  <style>
    :root{
      --border:#e6ecf1; --muted:#556070; --ink:#1b2a41;
      --pill:#eef2f7; --gradA:#5b2ca1; --gradB:#00b0f0;
      --hero:#cfe4e7;
    }

    /* Hero (consistent with other pages) */
    .hero{background:var(--hero);border-bottom:1px solid #c3d6d9;padding:56px 0 36px;margin-bottom:36px}
    .hero .container{max-width:1200px;margin:0 auto;padding:0 24px}
    .hero h1{margin:0 0 6px;font-weight:800;font-size:clamp(1.8rem,3vw,2.6rem);color:var(--ire-headline)}
    .hero p{margin:0;color:var(--muted)}
    .badge{display:inline-block;background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:700;color:#384454}

    /* Page container */
    .wrap{max-width:1200px;margin:0 auto;padding:0 24px}
    @media (max-width:640px){.wrap{padding:0 16px}}

    /* Card holds thread + sticky composer */
    .chat-card{
      position:relative;
      background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(28,39,51,.04);
      padding:18px;
      overflow:visible; /* let sticky sit nicely while the spacer keeps flow */
    }

    /* Thread + bubbles */
    .thread{min-height:280px;display:flex;flex-direction:column;gap:12px}
    .bubble{
      max-width:min(720px, 80%);padding:12px 14px;border-radius:14px;box-shadow:0 2px 10px rgba(27,42,65,.06)
    }
    .bubble.sys{background:#f6fbff;border:1px solid #dfeaf4;color:var(--ink)}
    .bubble.user{background:#efeaff;border:1px solid #e2d7ff;align-self:flex-end}

    .typing{
      display:inline-block;width:42px;height:12px;
      background:
        radial-gradient(currentColor 2px,transparent 3px) 0 50%/14px 12px,
        radial-gradient(currentColor 2px,transparent 3px) 50% 50%/14px 12px,
        radial-gradient(currentColor 2px,transparent 3px) 100% 50%/14px 12px;
      color:#a5b4fc;animation:blink 1.1s infinite ease-in-out
    }
    @keyframes blink{0%,100%{opacity:.3}50%{opacity:1}}

    /* Sticky composer anchored inside the card */
    .composer{
      position:sticky;bottom:0;left:0;right:0;background:#fff;
      margin-top:12px;border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 28px rgba(27,42,65,.08);
      padding:14px;z-index:2;
    }
    .composer header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .composer header .count{color:var(--muted);font-size:.9rem}
    .composer textarea{
      width:100%;min-height:140px;resize:vertical;padding:12px 14px;
      border:1px solid var(--border);border-radius:10px;font:inherit;line-height:1.5;box-sizing:border-box;
    }
    .composer .chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 8px}
    .composer .chip{background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:700;cursor:pointer}
    .composer .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .btn{
      appearance:none;border:0;border-radius:999px;padding:10px 16px;font-weight:800;color:#fff;
      background:linear-gradient(135deg,var(--gradA),var(--gradB));cursor:pointer
    }
    .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--border)}
    .note{color:var(--muted);font-size:.92rem;margin-top:10px}

    /* Spacer prevents next prompt from being under the sticky composer */
    #spacer{height:0}

    .visually-hidden{position:absolute !important;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>

  <!-- Hero -->
  <section class="hero">
    <div class="container">
      <h1>Reflection space</h1>
      <p>Thanks for completing the survey — here’s a space to expand on your thoughts in your own words.</p>
      <div class="badge" id="context-badge">Reflecting on: the survey item you just answered</div>
    </div>
  </section>

  <!-- Card with thread + composer -->
  <main class="wrap">
    <section class="chat-card">
      <div class="thread" id="thread" aria-live="polite" aria-relevant="additions"></div>
      <!-- spacer for sticky composer -->
      <div id="spacer" aria-hidden="true"></div>

      <div class="composer" role="group" aria-label="Reflection composer">
        <header>
          <div class="badge" id="step-badge">1 / 4</div>
          <div class="count"><span id="cc">0</span> / <span id="limit">600</span></div>
        </header>

        <textarea id="input" placeholder="Type your reflection here… (try for 2–3 sentences)"></textarea>

        <div class="chips" id="chips">
          <button type="button" class="chip" data-tag="mentoring">mentoring</button>
          <button type="button" class="chip" data-tag="workload">workload</button>
          <button type="button" class="chip" data-tag="recognition">recognition</button>
          <button type="button" class="chip" data-tag="community">community</button>
          <button type="button" class="chip" data-tag="training">training</button>
        </div>

        <div class="actions">
          <button type="button" id="send" class="btn">send</button>
          <button type="button" id="skip" class="btn ghost">skip question</button>
          <button type="button" id="clear" class="btn ghost">clear</button>
          <button type="button" id="finish" class="btn ghost">finish &amp; copy</button>
        </div>

        <label style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <input type="checkbox" id="quote-ok"/>
          <span>You may use a short anonymised quote from my reflections.</span>
        </label>

        <div class="note">
          Your reflections are anonymous and may be summarised with others. Saved locally on this device.
        </div>
      </div>
    </section>
  </main>

  <script>
    /* ----------------- Setup & state ----------------- */
    const thread   = document.getElementById('thread');
    const spacer   = document.getElementById('spacer');
    const composer = document.querySelector('.composer');
    const input    = document.getElementById('input');
    const cc       = document.getElementById('cc');
    const limitEl  = document.getElementById('limit');
    const stepBadge= document.getElementById('step-badge');
    const quoteOk  = document.getElementById('quote-ok');

    const LIMIT = 600;     // char limit for each answer
    limitEl.textContent = LIMIT;

    const QUESTIONS = [
      "What made you answer the way you did in the survey?",
      "Thanks — can you give an example or story that illustrates your experience?",
      "What helped or hindered you most in this situation?",
      "If one thing could change next time, what would it be?"
    ];

    const SKEY = 'ireacch-reflect-v1';
    const load = () => JSON.parse(localStorage.getItem(SKEY) || '{"i":0,"entries":[],"draft":""}');
    const save = (s) => localStorage.setItem(SKEY, JSON.stringify(s));
    let state = load();

    /* ----------------- Layout helpers ----------------- */
    function updateSpacer(){
      if(!composer || !spacer) return;
      spacer.style.height = (composer.offsetHeight + 16) + 'px';
    }
    window.addEventListener('resize', updateSpacer);
    const raf = fn => requestAnimationFrame(()=>requestAnimationFrame(fn));
    function scrollToEnd(){
      // Smoothly bring the latest content into view
      raf(()=>{
        const last = thread.lastElementChild;
        if(last){ last.scrollIntoView({behavior:'smooth', block:'end'}); }
      });
    }

    /* ----------------- UI helpers ----------------- */
    function setCount(){ cc.textContent = input.value.length; }

    function bubble(text, who='sys'){
      const b = document.createElement('div');
      b.className = `bubble ${who==='user'?'user':'sys'}`;
      b.textContent = text;
      thread.appendChild(b);
      updateSpacer();
      scrollToEnd();
      return b;
    }

    function typing(){
      const b = document.createElement('div');
      b.className = 'bubble sys';
      b.innerHTML = `<span class="typing" aria-hidden="true"></span><span class="visually-hidden">typing…</span>`;
      thread.appendChild(b);
      updateSpacer();
      scrollToEnd();
      return b;
    }

    function showFinal(){
      bubble("Thanks for reflecting — you’ve reached the end. You can still add more or finish & copy your notes.", 'sys');
      stepBadge.textContent = `${QUESTIONS.length} / ${QUESTIONS.length}`;
    }

    function nextPrompt(){
      const i = state.i;
      stepBadge.textContent = `${Math.min(i+1, QUESTIONS.length)} / ${QUESTIONS.length}`;

      if(i >= QUESTIONS.length){
        showFinal();
        return;
      }

      const t = typing();
      setTimeout(()=>{
        t.remove();
        bubble(QUESTIONS[i],'sys');
      }, 900); // keep visible long enough to notice
    }

    function renderFromState(){
      thread.innerHTML = '';
      state.entries.forEach(e=>{
        bubble(e.q,'sys');
        bubble(e.a,'user');
      });

      if(state.i < QUESTIONS.length){
        bubble(QUESTIONS[state.i],'sys');
      }else{
        showFinal();
      }

      input.value = state.draft || '';
      setCount();
      updateSpacer();
      scrollToEnd();
    }

    /* ----------------- events ----------------- */
    input.addEventListener('input', ()=>{
      if(input.value.length > LIMIT) input.value = input.value.slice(0, LIMIT);
      setCount();
      state.draft = input.value;
      save(state);
      updateSpacer();
    });

    document.getElementById('chips').addEventListener('click', (e)=>{
      const t = e.target?.dataset?.tag;
      if(!t) return;
      const needsSpace = input.value && !/\s$/.test(input.value);
      input.value += (needsSpace ? ' ' : '') + t;
      input.focus();
      input.dispatchEvent(new Event('input'));
    });

    document.getElementById('send').addEventListener('click', (ev)=>{
      ev.preventDefault();
      const txt = input.value.trim();
      if(!txt){ input.focus(); return; }

      bubble(txt,'user');

      state.entries.push({ q: QUESTIONS[state.i] || '', a: txt, quote: quoteOk.checked });
      state.i = Math.min(state.i+1, QUESTIONS.length);
      state.draft = '';
      save(state);

      input.value = '';
      setCount();

      nextPrompt();
    });

    document.getElementById('skip').addEventListener('click', (ev)=>{
      ev.preventDefault();
      state.i = Math.min(state.i+1, QUESTIONS.length);
      state.draft = '';
      save(state);
      input.value = ''; setCount();
      nextPrompt();
    });

    document.getElementById('clear').addEventListener('click', (ev)=>{
      ev.preventDefault();
      input.value=''; setCount(); state.draft=''; save(state); updateSpacer();
      input.focus();
    });

    document.getElementById('finish').addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const lines = [];
      state.entries.forEach((e,idx)=>{
        lines.push(`${idx+1}. ${e.q}`);
        lines.push(e.a);
        lines.push('');
      });
      const text = lines.join('\n');
      try{
        await navigator.clipboard.writeText(text);
        bubble("✅ Your reflections were copied to the clipboard. You can paste them into Word/Teams or keep them for your own notes.",'sys');
      }catch{
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); bubble("✅ Copied to clipboard.",'sys'); }catch{}
        document.body.removeChild(ta);
      }
      scrollToEnd();
    });

    /* ----------------- boot ----------------- */
    renderFromState();
  </script>
</body>
</html>
